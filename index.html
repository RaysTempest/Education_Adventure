<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Petualangan Pengetahuan Ultimate V9</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Fredoka+One&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #f0f9ff;
            --text-color: #0c4a6e;
            --card-bg-color: #ffffff;
            --modal-bg-color: #ffffff;
            --border-color: #e0e7ff;
            --header-bg: rgba(255, 255, 255, 0.7);
            --locked-filter: grayscale(1);
            --pattern-url: url('data:image/svg+xml;utf8,<svg width="100" height="100" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><g fill="%23a8c5ff" fill-opacity="0.1"><circle cx="50" cy="50" r="5" /><circle cx="10" cy="10" r="2" /><circle cx="90" cy="90" r="3" /><circle cx="10" cy="90" r="4" /><circle cx="90" cy="10" r="2" /></g></svg>');
        }
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg-color); 
            color: var(--text-color); 
            transition: background-color 0.5s, color 0.5s;
            background-image: var(--pattern-url);
        }
        .font-brand { font-family: 'Fredoka One', cursive; }
        .card-hover { transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .card-hover:hover { transform: translateY(-10px) scale(1.05); box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1); }
        .screen, .modal-overlay { display: none; }
        .screen.active, .modal-overlay.active { display: flex; animation: fadeIn 0.5s ease-in-out forwards; }
        .avatar { width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2rem; color: white; transition: transform 0.3s; }
        .avatar:hover { transform: scale(1.1); }
        .tts-button:hover, .hint-button:hover { color: #1d4ed8; background-color: #dbeafe; }
        .avatar-selection { cursor: pointer; border: 4px solid transparent; border-radius: 50%; transition: all 0.2s ease; position: relative; }
        .avatar-selection.selected { border-color: #2563eb; transform: scale(1.1); box-shadow: 0 0 15px rgba(37, 99, 235, 0.5); }
        .shop-item { cursor: pointer; border: 4px solid var(--border-color); border-radius: 1.5rem; transition: all 0.2s ease; position: relative; background-color: var(--card-bg-color); }
        .shop-item:hover { transform: scale(1.05); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .shop-item.owned { border-color: #16a34a; }
        .shop-item.equipped { border-color: #2563eb; box-shadow: 0 0 20px rgba(37, 99, 235, 0.6); }
        .shop-item.locked::after { content: '🔒'; position: absolute; top: 8px; right: 8px; font-size: 1.5rem; background: rgba(0,0,0,0.4); color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; }
        .price-tag { position: absolute; bottom: -10px; left: 50%; transform: translateX(-50%); background: #fbbf24; color: #78350f; font-weight: bold; padding: 2px 10px; border-radius: 99px; font-size: 0.9rem; border: 2px solid white; }
        .point-animation { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 2.5rem; font-weight: bold; color: #f59e0b; z-index: 100; animation: floatUp 1.5s ease-out forwards; pointer-events: none; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .mascot-tip { position: fixed; bottom: 20px; left: 20px; background-color: white; padding: 15px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); z-index: 100; display: flex; align-items: center; max-width: 300px; animation: slideInUp 0.5s ease-out; }
        .bonus-world-badge { position: absolute; top: -10px; right: -10px; background-color: #ef4444; color: white; font-weight: bold; font-size: 0.75rem; padding: 2px 8px; border-radius: 99px; transform: rotate(15deg); animation: pulse 1.5s infinite; }
        
        body.dark {
            --bg-color: #0b1120;
            --text-color: #d1d5db;
            --card-bg-color: #1f2937;
            --modal-bg-color: #111827;
            --border-color: #374151;
            --header-bg: rgba(31, 41, 55, 0.7);
            --locked-filter: grayscale(1) invert(0.75);
            --pattern-url: url('data:image/svg+xml;utf8,<svg width="100" height="100" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><g fill="%234b5563" fill-opacity="0.2"><circle cx="50" cy="50" r="5" /><circle cx="10" cy="10" r="2" /><circle cx="90" cy="90" r="3" /><circle cx="10" cy="90" r="4" /><circle cx="90" cy="10" r="2" /></g></svg>');
        }
        
        .star-animation { animation: star-pop 0.5s ease-in-out; }
        @keyframes star-pop { 0% { transform: scale(0); } 80% { transform: scale(1.5); } 100% { transform: scale(1); } }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes scaleUp { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes floatUp { from { opacity: 1; transform: translate(-50%, -50%) scale(1); } to { opacity: 0; transform: translate(-50%, -250%) scale(1.5); } }
        @keyframes slideInUp { from { transform: translateY(100px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes pulse { 0%, 100% { transform: scale(1) rotate(15deg); } 50% { transform: scale(1.1) rotate(15deg); } }
    </style>
</head>
<body class="text-gray-800">
    <audio id="background-music" loop>
        <source src="https://www.chosic.com/wp-content/uploads/2021/4/purrple-cat-wondering.mp3" type="audio/mpeg">
    </audio>

    <div id="app" class="min-h-screen flex flex-col items-center justify-center p-4">

        <div id="loading-screen" class="screen active text-center flex-col w-full">
            <h1 class="font-brand text-5xl md:text-7xl text-sky-700 mb-4">Petualangan Pengetahuan</h1>
            <div class="animate-pulse text-2xl text-gray-600">Mempersiapkan Petualangan...</div>
        </div>
        
        <div id="user-selection-screen" class="screen text-center flex-col w-full max-w-4xl">
            <h1 class="font-brand text-5xl md:text-7xl text-sky-700 mb-4">Petualangan Pengetahuan</h1>
            <p class="text-lg md:text-xl text-gray-600 mb-8">Siapa yang akan berpetualang hari ini?</p>
            <div id="user-list-container" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 mb-8"></div>
            <button id="add-new-user-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-4 px-8 rounded-full shadow-lg transform hover:scale-110 transition-transform duration-300 text-xl">+ Tambah Pengguna Baru</button>
        </div>

        <div id="name-entry-screen" class="screen flex-col w-full max-w-lg">
            <div class="bg-white p-8 rounded-3xl shadow-2xl w-full text-center">
                 <h1 class="font-brand text-4xl text-sky-700 mb-2">Buat Profil Baru</h1>
                 <p class="text-gray-600 mb-6">Masukkan nama dan pilih avatarmu!</p>
                 <input type="text" id="player-name-input" placeholder="Contoh: Budi" class="text-center text-2xl p-4 border-2 border-sky-300 rounded-xl shadow-inner focus:border-orange-500 focus:ring-orange-500 mb-6 w-full">
                 <p class="font-semibold mb-4">Pilih Avatar:</p>
                 <div id="avatar-selection-container" class="flex justify-center gap-4 mb-8">
                    </div>
                 <div class="flex gap-4">
                    <button id="cancel-new-user-btn" class="w-full bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-3 px-6 rounded-xl shadow-md transition-transform duration-300">Batal</button>
                    <button id="next-to-level-btn" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg transition-transform duration-300 disabled:bg-gray-400" disabled>Lanjut</button>
                 </div>
            </div>
        </div>
        
        <div id="jenjang-screen" class="screen text-center flex-col w-full max-w-3xl">
            <h1 class="font-brand text-4xl md:text-6xl text-sky-700 mb-2">Pilih Jenjangmu</h1>
            <p class="text-lg md:text-xl text-gray-600 mb-8" id="jenjang-prompt-name"></p>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 w-full max-w-2xl">
                <button data-jenjang="sd" class="jenjang-btn bg-green-500 hover:bg-green-600 text-white font-bold py-6 px-8 rounded-2xl shadow-lg transform hover:scale-105 transition-transform duration-300 text-2xl"><span class="text-4xl block mb-2">🎓</span> SD</button>
                <button data-jenjang="smp" class="jenjang-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-6 px-8 rounded-2xl shadow-lg transform hover:scale-105 transition-transform duration-300 text-2xl"><span class="text-4xl block mb-2">📚</span> SMP</button>
                <button data-jenjang="sma" class="jenjang-btn bg-purple-500 hover:bg-purple-600 text-white font-bold py-6 px-8 rounded-2xl shadow-lg transform hover:scale-105 transition-transform duration-300 text-2xl"><span class="text-4xl block mb-2">🔬</span> SMA</button>
                <button data-jenjang="kuliah" class="jenjang-btn bg-red-500 hover:bg-red-600 text-white font-bold py-6 px-8 rounded-2xl shadow-lg transform hover:scale-105 transition-transform duration-300 text-2xl"><span class="text-4xl block mb-2">💼</span> Mahasiswa</button>
            </div>
        </div>

        <div id="map-screen" class="screen w-full max-w-7xl mx-auto flex-col">
            <header class="flex flex-wrap justify-between items-center mb-6 px-4 gap-4 w-full backdrop-blur-sm p-4 rounded-2xl shadow" style="background-color: var(--header-bg)">
                 <div class="flex items-center gap-4">
                    <div id="user-avatar-header" class="avatar w-16 h-16 cursor-pointer" title="Ganti Pengguna"></div>
                    <div>
                        <h2 class="font-brand text-2xl md:text-4xl text-sky-800" id="welcome-message"></h2>
                        <h3 class="font-semibold text-lg text-amber-700" id="user-title-display"></h3>
                        <div class="flex items-center gap-4">
                            <p class="text-md md:text-lg font-bold text-amber-600" id="points-display"></p>
                            <p class="text-md md:text-lg font-bold text-red-500" id="streak-display" title="Bonus login beruntun!"></p>
                        </div>
                    </div>
                 </div>
                 <div class="flex items-center gap-2 flex-wrap justify-center">
                    <button id="shop-hub-btn" class="bg-violet-500 hover:bg-violet-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:scale-105">🛍️ Toko</button>
                    <button id="daily-mission-btn" class="bg-cyan-500 hover:bg-cyan-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:scale-105">🎯 Misi</button>
                    <button id="leaderboard-btn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:scale-105">🥇 Peringkat</button>
                    <button id="achievements-btn" class="bg-amber-500 hover:bg-amber-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:scale-105">🏆 Prestasi</button>
                    <button id="settings-btn" class="bg-gray-700 hover:bg-gray-800 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:scale-105">⚙️</button>
                </div>
            </header>
            <div class="w-full mb-4 px-2">
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div class="bg-white/60 p-3 rounded-lg shadow">
                         <h3 class="font-bold text-center text-sky-800">📚 Kata Hari Ini</h3>
                         <p id="word-of-the-day" class="text-center text-sm"></p>
                    </div>
                    <div class="bg-white/60 p-3 rounded-lg shadow flex items-center justify-around">
                        <button id="review-mode-btn" class="bg-teal-500 hover:bg-teal-600 text-white font-semibold py-2 px-3 rounded-lg text-sm">🔁 Ulas Kembali</button>
                        <button id="timed-challenge-btn" class="bg-rose-500 hover:bg-rose-600 text-white font-semibold py-2 px-3 rounded-lg text-sm">⏱️ Tantangan Waktu</button>
                    </div>
                </div>
                <input type="text" id="search-bar" placeholder="🔍 Cari dunia atau topik..." class="w-full p-3 rounded-lg border-2 border-sky-200 shadow-sm">
            </div>
            <div id="dunia-container" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6 md:gap-8 w-full"></div>
        </div>
        
        <div id="submateri-screen" class="screen w-full max-w-5xl mx-auto flex-col">
             <h2 id="submateri-title" class="font-brand text-4xl md:text-5xl text-center mb-10"></h2>
             <div id="submateri-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
             <div class="text-center mt-8"><button id="back-to-worlds-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-full shadow-lg transform hover:scale-105">&larr; Kembali ke Peta Dunia</button></div>
       </div>

       <div id="materi-screen" class="screen w-full max-w-4xl mx-auto bg-white p-6 md:p-10 rounded-2xl shadow-2xl flex-col">
           <div id="materi-content" class="w-full"></div>
            <div class="text-center mt-8 w-full"><button id="back-to-submateri-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-full shadow-lg transform hover:scale-105">&larr; Kembali Pilih Materi</button></div>
       </div>
    </div>

    <div id="avatar-shop-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 items-center justify-center p-4 z-50">
        <div class="modal-content bg-white rounded-2xl p-8 shadow-2xl w-full max-w-2xl scale-up">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-brand text-3xl text-violet-600">👕 Toko Avatar 👕</h3>
                <div class="font-bold text-amber-600 text-xl bg-amber-100 px-4 py-2 rounded-full" id="shop-points-display"></div>
            </div>
            <div id="avatar-shop-container" class="grid grid-cols-3 md:grid-cols-4 gap-6 max-h-80 overflow-y-auto p-4 bg-gray-50 rounded-lg">
                </div>
            <button id="close-avatar-shop-btn" class="mt-6 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded-full shadow-lg w-full">Tutup</button>
        </div>
    </div>
    
    <div id="shop-hub-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 items-center justify-center p-4 z-50">
        <div class="modal-content bg-white rounded-2xl p-8 shadow-2xl w-full max-w-2xl scale-up">
            <h3 class="font-brand text-4xl text-violet-600 text-center mb-6">Pusat Perbelanjaan</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-center">
                <div id="open-avatar-shop" class="p-6 bg-rose-100 rounded-2xl cursor-pointer card-hover border-2 border-rose-300">
                    <div class="text-5xl mb-2">👕</div>
                    <h4 class="font-bold text-xl text-rose-800">Toko Avatar</h4>
                    <p class="text-sm text-rose-600">Ganti penampilanmu!</p>
                </div>
                <div id="open-customization-shop" class="p-6 bg-sky-100 rounded-2xl cursor-pointer card-hover border-2 border-sky-300">
                    <div class="text-5xl mb-2">🎨</div>
                    <h4 class="font-bold text-xl text-sky-800">Warung Kustomisasi</h4>
                    <p class="text-sm text-sky-600">Ubah tema & warna.</p>
                </div>
                <div id="open-powerup-shop" class="p-6 bg-amber-100 rounded-2xl cursor-pointer card-hover border-2 border-amber-300">
                    <div class="text-5xl mb-2">⚡</div>
                    <h4 class="font-bold text-xl text-amber-800">Pasar Kekuatan</h4>
                    <p class="text-sm text-amber-600">Beli item bantuan.</p>
                </div>
                <div id="open-mascot-shop" class="p-6 bg-emerald-100 rounded-2xl cursor-pointer card-hover border-2 border-emerald-300">
                    <div class="text-5xl mb-2">🦉</div>
                    <h4 class="font-bold text-xl text-emerald-800">Butik Cendekia</h4>
                    <p class="text-sm text-emerald-600">Hiasi maskotmu.</p>
                </div>
            </div>
            <button id="close-shop-hub-btn" class="mt-8 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded-full w-full">Tutup</button>
        </div>
    </div>
    
    <div id="generic-shop-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 items-center justify-center p-4 z-50">
        <div class="modal-content bg-white rounded-2xl p-8 shadow-2xl w-full max-w-3xl scale-up">
            <div class="flex justify-between items-center mb-6">
                <h3 id="generic-shop-title" class="font-brand text-3xl">Nama Toko</h3>
                <div class="font-bold text-amber-600 text-xl bg-amber-100 px-4 py-2 rounded-full" id="generic-shop-points"></div>
            </div>
            <div id="generic-shop-container" class="grid grid-cols-2 md:grid-cols-3 gap-4 max-h-80 overflow-y-auto p-4 bg-gray-50 rounded-lg">
                </div>
            <button class="generic-shop-close-btn mt-6 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded-full shadow-lg w-full">Tutup</button>
        </div>
    </div>
    
    <div id="settings-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 items-center justify-center p-4 z-50">
        <div class="modal-content bg-white rounded-2xl p-6 shadow-2xl w-full max-w-md scale-up">
            <h3 class="font-brand text-3xl text-sky-800 text-center mb-4">Pengaturan</h3>
            <div class="w-full">
                <div class="border-b border-gray-200">
                    <nav class="-mb-px flex space-x-4" aria-label="Tabs">
                        <button class="settings-tab whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-sky-500 text-sky-600" data-tab="general">Umum</button>
                        <button class="settings-tab whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="appearance">Tampilan</button>
                        <button class="settings-tab whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="account">Akun</button>
                    </nav>
                </div>
                <div id="settings-tab-content" class="py-4">
                    <div class="settings-tab-pane active" id="tab-general">
                        <div class="flex justify-between items-center p-3 bg-gray-100 rounded-lg mb-3">
                            <label for="sound-toggle" class="font-semibold">Efek Suara</label>
                            <button id="sound-toggle" class="text-2xl">🔊</button>
                        </div>
                         <div class="flex justify-between items-center p-3 bg-gray-100 rounded-lg">
                            <label for="music-toggle" class="font-semibold">Musik Latar</label>
                            <button id="music-toggle" class="text-2xl">🎵</button>
                        </div>
                    </div>
                    <div class="settings-tab-pane" id="tab-appearance" style="display: none;">
                         <span class="block font-semibold mb-2">Tema Tampilan</span>
                         <div class="flex gap-2" id="theme-selector">
                             <button data-theme="light" class="w-full p-2 border-2 rounded-lg font-semibold">☀️ Terang</button>
                             <button data-theme="dark" class="w-full p-2 border-2 rounded-lg font-semibold">🌙 Gelap</button>
                         </div>
                    </div>
                    <div class="settings-tab-pane" id="tab-account" style="display: none;">
                        <div class="space-y-4">
                             <div>
                                <label for="edit-name-input" class="block font-semibold mb-2">Ganti Nama Pengguna</label>
                                <div class="flex gap-2">
                                    <input type="text" id="edit-name-input" class="w-full p-2 border-2 border-gray-300 rounded-lg">
                                    <button id="save-name-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Simpan</button>
                                </div>
                            </div>
                            <div>
                                <label for="change-jenjang-select" class="block font-semibold mb-2">Ganti Jenjang</label>
                                <select id="change-jenjang-select" class="w-full p-2 border-2 border-gray-300 rounded-lg">
                                    <option value="sd">SD</option><option value="smp">SMP</option><option value="sma">SMA</option><option value="kuliah">Mahasiswa</option>
                                </select>
                            </div>
                             <hr/>
                            <button id="reset-progress-btn" class="w-full text-left p-3 bg-red-100 hover:bg-red-200 text-red-700 rounded-lg font-bold">🗑️ Reset Progres Pengguna Ini</button>
                        </div>
                    </div>
                </div>
            </div>
            <button id="close-settings-btn" class="mt-4 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded-full w-full">Tutup</button>
        </div>
    </div>
    
    <div id="daily-bonus-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 items-center justify-center p-4 z-50">
        <div class="modal-content bg-white rounded-2xl p-8 shadow-2xl w-full max-w-sm text-center scale-up">
            <h3 class="font-brand text-3xl text-yellow-500">Bonus Login Harian!</h3>
            <div class="text-7xl my-4 animate-bounce">💰</div>
            <p class="text-gray-600 text-lg mb-2">Kamu mendapatkan <strong class="text-amber-600" id="daily-bonus-amount">50 Poin</strong>!</p>
            <p class="text-gray-600 text-lg mb-4" id="daily-streak-bonus-text"></p>
            <button id="close-daily-bonus-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-full w-full">Asyik!</button>
        </div>
    </div>

    <div id="confirm-reset-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 items-center justify-center p-4 z-50">
        <div class="modal-content bg-white rounded-2xl p-8 shadow-2xl w-full max-w-sm text-center scale-up">
            <h3 class="font-bold text-2xl text-red-700">PERINGATAN!</h3>
            <p class="text-gray-600 my-4">Yakin ingin mereset progres untuk <strong id="reset-username-confirm"></strong>? Semua poin & lencana akan hilang.</p>
            <div class="flex justify-center gap-4 mt-6">
                <button id="cancel-reset-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-full">Batal</button>
                <button id="confirm-reset-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-full">Ya, Yakin</button>
            </div>
        </div>
    </div>
    <div id="fun-fact-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-60 items-center justify-center p-4 z-50">
        <div class="modal-content bg-white rounded-2xl p-8 shadow-2xl w-full max-w-md text-center scale-up">
            <div id="mascot-container" class="w-24 h-24 mx-auto mb-4">
                 <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><g><path d="M50,15 C25,15 10,35 10,55 C10,80 25,95 50,95 C75,95 90,80 90,55 C90,35 75,15 50,15 Z" fill="#4CAF50"/><path d="M35,45 C40,40 50,40 55,45 C60,50 60,60 55,65 L45,65 C40,60 40,50 35,45 Z" fill="#388E3C" transform="translate(-15, 0)"/><path d="M65,45 C60,40 50,40 45,45 C40,50 40,60 45,65 L55,65 C60,60 60,50 65,45 Z" fill="#388E3C" transform="translate(15, 0)"/><circle cx="32" cy="52" r="18" fill="white"/><circle cx="68" cy="52" r="18" fill="white"/><circle cx="33" cy="53" r="8" fill="black"/><circle cx="67" cy="53" r="8" fill="black"/><path d="M50,65 C55,75 45,75 50,65 L52,70 L48,70 Z" fill="#FFC107"/><path d="M20,15 Q30,5 40,15" stroke="#388E3C" stroke-width="4" fill="none" stroke-linecap="round"/><path d="M80,15 Q70,5 60,15" stroke="#388E3C" stroke-width="4" fill="none" stroke-linecap="round"/></g></svg>
            </div>
            <h3 class="font-brand text-2xl text-sky-700">Fakta Seru!</h3><p id="fun-fact-text" class="text-gray-700 my-4"></p><button id="close-fun-fact-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-full shadow-lg">Lanjut!</button>
        </div>
    </div>
    <div id="achievements-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-60 items-center justify-center p-4 z-50">
        <div class="modal-content bg-white rounded-2xl p-8 shadow-2xl w-full max-w-lg scale-up">
            <div class="flex justify-between items-center mb-4">
                 <h3 class="font-brand text-3xl text-amber-600 text-center">🏆 Prestasiku 🏆</h3>
                 <button id="share-progress-btn" title="Bagikan Prestasi" class="bg-blue-500 hover:bg-blue-600 text-white font-bold p-2 rounded-full shadow-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path><polyline points="16 6 12 2 8 6"></polyline><line x1="12" y1="2" x2="12" y2="15"></line></svg>
                 </button>
            </div>
            <div id="achievements-list" class="space-y-3 max-h-80 overflow-y-auto"></div><button id="close-achievements-btn" class="mt-6 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded-full shadow-lg w-full">Tutup</button>
        </div>
    </div>
    <div id="leaderboard-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-60 items-center justify-center p-4 z-50">
        <div class="modal-content bg-white rounded-2xl p-8 shadow-2xl w-full max-w-lg scale-up">
            <h3 class="font-brand text-3xl text-yellow-600 text-center mb-4">🥇 Papan Peringkat 🥇</h3>
            <div id="leaderboard-list" class="space-y-2 max-h-80 overflow-y-auto"></div>
            <button id="close-leaderboard-btn" class="mt-6 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded-full shadow-lg w-full">Tutup</button>
        </div>
    </div>
    <div id="daily-mission-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-60 items-center justify-center p-4 z-50">
        <div class="modal-content bg-white rounded-2xl p-8 shadow-2xl w-full max-w-md text-center scale-up">
            <h3 class="font-brand text-3xl text-cyan-600 text-center mb-4">🎯 Misi Harian 🎯</h3>
            <p id="daily-mission-text" class="text-gray-700 text-lg my-4"></p>
            <div id="mission-progress-container" class="w-full bg-gray-200 rounded-full h-6 my-4">
                <div id="mission-progress-bar" class="bg-cyan-500 h-6 rounded-full text-white flex items-center justify-center text-sm font-bold" style="width: 0%;">0%</div>
            </div>
            <button id="claim-mission-reward-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-full shadow-lg w-full disabled:bg-gray-400 disabled:cursor-not-allowed">Klaim Hadiah</button>
            <button id="close-daily-mission-btn" class="mt-4 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded-full shadow-lg w-full">Tutup</button>
        </div>
    </div>
    <div id="certificate-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-60 items-center justify-center p-4 z-50">
        <div class="modal-content bg-slate-50 rounded-2xl p-8 shadow-2xl w-full max-w-2xl scale-up border-8 border-amber-400" style="background-image: url('https://www.transparenttextures.com/patterns/light-paper-fibers.png');">
            <div class="text-center">
                 <h2 class="font-brand text-2xl text-gray-500">Sertifikat Petualang Pengetahuan</h2>
                 <h1 class="font-brand text-5xl text-sky-700 my-4" id="certificate-name"></h1>
                 <p class="text-lg text-gray-600">Telah dengan gemilang menyelesaikan seluruh tantangan di jenjangnya!</p>
                 <div class="my-6 text-5xl">🎉 🌟 🎓 🌟 🎉</div><button id="close-certificate-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-8 rounded-full shadow-lg">Luar Biasa!</button>
            </div>
        </div>
    </div>
     <div id="timed-challenge-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 items-center justify-center p-4 z-50">
        <div class="modal-content bg-white rounded-2xl p-8 shadow-2xl w-full max-w-xl text-center scale-up">
            <h3 class="font-brand text-3xl text-rose-600">⏱️ Tantangan Waktu ⏱️</h3>
            <div id="challenge-timer" class="my-4 text-2xl font-bold"></div>
            <div id="challenge-question-area"></div>
            <div id="challenge-feedback" class="mt-4 font-bold"></div>
            <button id="close-timed-challenge-btn" class="hidden mt-4 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded-full w-full">Tutup</button>
        </div>
    </div>
     <div id="stats-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-60 items-center justify-center p-4 z-50">
        <div class="modal-content bg-white rounded-2xl p-8 shadow-2xl w-full max-w-md scale-up">
            <h3 class="font-brand text-3xl text-sky-800 text-center mb-4" id="stats-username">Statistik Budi</h3>
            <div id="stats-content" class="space-y-3"></div>
            <button id="close-stats-btn" class="mt-6 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded-full w-full">Tutup</button>
        </div>
    </div>

    <div id="point-animation-container"></div>
    <div id="mascot-tip-container"></div>

    <script>
        // --- DATA APLIKASI ---

        // Database Avatar
        const avatarData = {
            'avatar1': { svg: `<svg viewBox="0 0 36 36" fill="none" role="img" xmlns="http://www.w3.org/2000/svg" width="80" height="80"><mask id="mask__beam" maskUnits="userSpaceOnUse" x="0" y="0" width="36" height="36"><rect width="36" height="36" fill="#FFFFFF" rx="72"></rect></mask><g mask="url(#mask__beam)"><rect width="36" height="36" fill="#75d475"></rect><rect x="0" y="0" width="36" height="36" transform="translate(4 4) rotate(268 18 18) scale(1.2)" fill="#248038" rx="36"></rect><g transform="translate(-4 -1) rotate(8 18 18)"><path d="M15 21c2 1 4 1 6 0" stroke="#000000" fill="none" stroke-linecap="round"></path><rect x="10" y="14" width="1.5" height="2" rx="1" stroke="none" fill="#000000"></rect><rect x="24" y="14" width="1.5" height="2" rx="1" stroke="none" fill="#000000"></rect></g></g></svg>`, price: 0, isStarter: true },
            'avatar2': { svg: `<svg viewBox="0 0 36 36" fill="none" role="img" xmlns="http://www.w3.org/2000/svg" width="80" height="80"><mask id="mask__beam" maskUnits="userSpaceOnUse" x="0" y="0" width="36" height="36"><rect width="36" height="36" fill="#FFFFFF" rx="72"></rect></mask><g mask="url(#mask__beam)"><rect width="36" height="36" fill="#84b6e0"></rect><rect x="0" y="0" width="36" height="36" transform="translate(0 0) rotate(329 18 18) scale(1.2)" fill="#25648a" rx="36"></rect><g transform="translate(0 5) rotate(-9 18 18)"><path d="M15 21c2 1 4 1 6 0" stroke="#FFFFFF" fill="none" stroke-linecap="round"></path><rect x="14" y="14" width="1.5" height="2" rx="1" stroke="none" fill="#FFFFFF"></rect><rect x="20" y="14" width="1.5" height="2" rx="1" stroke="none" fill="#FFFFFF"></rect></g></g></svg>`, price: 0, isStarter: true },
            'avatar3': { svg: `<svg viewBox="0 0 36 36" fill="none" role="img" xmlns="http://www.w3.org/2000/svg" width="80" height="80"><mask id="mask__beam" maskUnits="userSpaceOnUse" x="0" y="0" width="36" height="36"><rect width="36" height="36" fill="#f0c38e"></rect></mask><g mask="url(#mask__beam)"><rect width="36" height="36" fill="#f0c38e"></rect><rect x="0" y="0" width="36" height="36" transform="translate(8 -6) rotate(114 18 18) scale(1.2)" fill="#a07d58" rx="36"></rect><g transform="translate(4 -4) rotate(-4 18 18)"><path d="M13,21 a8,8 0 0,0 10,0" fill="#000000"></path><rect x="14" y="14" width="1.5" height="2" rx="1" stroke="none" fill="#000000"></rect><rect x="20" y="14" width="1.5" height="2" rx="1" stroke="none" fill="#000000"></rect></g></g></svg>`, price: 0, isStarter: true },
            'avatar4': { svg: `<svg viewBox="0 0 36 36" fill="none" role="img" xmlns="http://www.w3.org/2000/svg" width="80" height="80"><mask id="mask__beam" maskUnits="userSpaceOnUse" x="0" y="0" width="36" height="36"><rect width="36" height="36" fill="#FFFFFF" rx="72"></rect></mask><g mask="url(#mask__beam)"><rect width="36" height="36" fill="#e0a3a3"></rect><rect x="0" y="0" width="36" height="36" transform="translate(-4 -4) rotate(278 18 18) scale(1.1)" fill="#9c5656" rx="64"></rect><g transform="translate(-4 0) rotate(8 18 18)"><path d="M15 19c2 1 4 1 6 0" stroke="#FFFFFF" fill="none" stroke-linecap="round"></path><rect x="11" y="14" width="1.5" height="2" rx="1" stroke="none" fill="#FFFFFF"></rect><rect x="23" y="14" width="1.5" height="2" rx="1" stroke="none" fill="#FFFFFF"></rect></g></g></svg>`, price: 0, isStarter: true },
            'avatar5': { svg: `<svg width="80" height="80" viewBox="0 0 36 36" fill="none" xmlns="http://www.w3.org/2000/svg"><mask id="mask0_33_33" style="mask-type:alpha" maskUnits="userSpaceOnUse" x="0" y="0" width="36" height="36"><circle cx="18" cy="18" r="18" fill="#D9D9D9"/></mask><g mask="url(#mask0_33_33)"><rect width="36" height="36" fill="#F2D4A7"/><ellipse cx="18" cy="33.5" rx="18" ry="13.5" fill="#3B2219"/><path d="M-5 13C-5 5.8203 0.8203 -1.13379e-06 8 -1.13379e-06V13H-5Z" fill="#6A463A"/><path d="M41 13C41 5.8203 35.1797 -1.13379e-06 28 -1.13379e-06V13H41Z" fill="#6A463A"/><rect x="11" y="16" width="3" height="4" rx="1.5" fill="white"/><rect x="22" y="16" width="3" height="4" rx="1.5" fill="white"/><path d="M13 23C13 23 15 25 18 25C21 25 23 23 23 23" stroke="white" stroke-width="2" stroke-linecap="round"/></g></svg>`, price: 200 },
            'avatar6': { svg: `<svg width="80" height="80" viewBox="0 0 36 36" fill="none" xmlns="http://www.w3.org/2000/svg"><mask id="mask0_33_41" style="mask-type:alpha" maskUnits="userSpaceOnUse" x="0" y="0" width="36" height="36"><circle cx="18" cy="18" r="18" fill="white"/></mask><g mask="url(#mask0_33_41)"><rect width="36" height="36" fill="#A7CFF2"/><rect x="11" y="16" width="3" height="4" rx="1.5" fill="#223B4E"/><rect x="22" y="16" width="3" height="4" rx="1.5" fill="#223B4E"/><path d="M13 23L23 23" stroke="#223B4E" stroke-width="2" stroke-linecap="round"/><path d="M11 12L7 9" stroke="#223B4E" stroke-width="2" stroke-linecap="round"/><path d="M25 12L29 9" stroke="#223B4E" stroke-width="2" stroke-linecap="round"/></g></svg>`, price: 250 },
            'avatar7': { svg: `<svg width="80" height="80" viewBox="0 0 36 36" fill="none" xmlns="http://www.w3.org/2000/svg"><mask id="mask0_33_49" style="mask-type:alpha" maskUnits="userSpaceOnUse" x="0" y="0" width="36" height="36"><circle cx="18" cy="18" r="18" fill="white"/></mask><g mask="url(#mask0_33_49)"><rect width="36" height="36" fill="#F2A7A7"/><path d="M36 18C36 8.05887 27.9411 0 18 0C8.05887 0 0 8.05887 0 18H36Z" fill="#D16F6F"/><rect x="11" y="16" width="3" height="4" rx="1.5" fill="#5A2E2E"/><rect x="22" y="16" width="3" height="4" rx="1.5" fill="#5A2E2E"/><path d="M15 25C15 25 16.5 23 18 23C19.5 23 21 25 21 25" stroke="#5A2E2E" stroke-width="2" stroke-linecap="round"/></g></svg>`, price: 300 },
            'avatar8': { svg: `<svg width="80" height="80" viewBox="0 0 36 36" fill="none" xmlns="http://www.w3.org/2000/svg"><rect width="36" height="36" rx="18" fill="#BEBEBE"/><rect x="10" y="15" width="4" height="6" fill="#1E1E1E"/><rect x="22" y="15" width="4" height="6" fill="#1E1E1E"/><path d="M10 25L26 25" stroke="#1E1E1E" stroke-width="2"/><path d="M4 11L10 5" stroke="#1E1E1E" stroke-width="2" stroke-linecap="round"/><path d="M32 11L26 5" stroke="#1E1E1E" stroke-width="2" stroke-linecap="round"/></svg>`, price: 500 },
            'avatar_astronaut': { svg: `<svg width="80" height="80" viewBox="0 0 36 36" fill="none" xmlns="http://www.w3.org/2000/svg"><g clip-path="url(#clip0_803_2)"><rect width="36" height="36" rx="18" fill="white"/><rect x="-5" y="15" width="46" height="27" fill="#474D54"/><ellipse cx="18" cy="18" rx="13" ry="12" fill="#75D4EB"/><path d="M18 18L10 18" stroke="white" stroke-width="2" stroke-linecap="round"/><ellipse cx="18" cy="18" rx="10" ry="9" fill="#292D32"/><path d="M22 17C22.5931 18.0538 21.3333 19.3333 20 19C18.6667 18.6667 19.2931 16.9462 20 17C20.7069 17.0538 21.4069 15.9462 22 17Z" fill="white" fill-opacity="0.5"/></g></svg>`, price: 750, name: "Astronot" },
            'avatar_knight': { svg: `<svg width="80" height="80" viewBox="0 0 36 36" fill="none" xmlns="http://www.w3.org/2000/svg"><rect width="36" height="36" rx="18" fill="#E0E0E0"/><path d="M7 16H29V25H7V16Z" fill="#BDBDBD"/><path d="M11 10H25L29 16H7L11 10Z" fill="#BDBDBD"/><rect x="17" y="18" width="2" height="5" fill="#424242"/><path d="M11 10L18 4L25 10" stroke="#EF5350" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`, price: 800, name: "Ksatria Baja" },
            'avatar_wizard': { svg: `<svg width="80" height="80" viewBox="0 0 36 36" fill="none" xmlns="http://www.w3.org/2000/svg"><rect width="36" height="36" rx="18" fill="#7E57C2"/><path d="M18 4L8 28H28L18 4Z" fill="#5E35B1"/><circle cx="18" cy="18" r="2" fill="#FDD835"/><path d="M16 18L10 16" stroke="#FDD835" stroke-width="1.5" stroke-linecap="round"/><path d="M20 18L26 16" stroke="#FDD835" stroke-width="1.5" stroke-linecap="round"/><path d="M18 20V26" stroke="#FDD835" stroke-width="1.5" stroke-linecap="round"/></svg>`, price: 850, name: "Penyihir Cahaya" },
            'avatar_garuda': { svg: `<svg width="80" height="80" viewBox="0 0 36 36" fill="none" xmlns="http://www.w3.org/2000/svg"><rect width="36" height="36" rx="18" fill="#FFC107"/><path d="M18 14C12 14 8 20 8 20H28C28 20 24 14 18 14Z" fill="#F57F17"/><path d="M18 24V18" stroke="#795548" stroke-width="2"/><circle cx="14" cy="18" r="2" fill="black"/><circle cx="22" cy="18" r="2" fill="black"/></svg>`, price: 2000, name: "Garuda Emas" },
            'avatar_cyborg': { svg: `<svg width="80" height="80" viewBox="0 0 36 36" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M18 0C8.05888 0 0 8.05888 0 18C0 27.9411 8.05888 36 18 36V0Z" fill="#84b6e0"/><path d="M18 0C27.9411 0 36 8.05888 36 18C36 27.9411 27.9411 36 18 36V0Z" fill="#BDBDBD"/><rect x="10" y="14" width="1.5" height="2" rx="1" fill="white"/><rect x="24" y="14" width="2" height="4" rx="1" fill="#FF5252"/></svg>`, price: 1300, name: "Cyborg" },
            'avatar_detective': { svg: `<svg width="80" height="80" viewBox="0 0 36 36" fill="none" xmlns="http://www.w3.org/2000/svg"><rect width="36" height="36" rx="18" fill="#A1887F"/><path d="M4 18H32V24C32 28.4183 25.6127 32 18 32C10.3873 32 4 28.4183 4 24V18Z" fill="#795548"/><rect x="4" y="16" width="28" height="2" fill="#3E2723"/><circle cx="24" cy="24" r="5" stroke="black" stroke-width="2"/><line x1="28" y1="28" x2="32" y2="32" stroke="black" stroke-width="2"/></svg>`, price: 700, name: "Detektif" },
        };

        const shopData = {
            customization: {
                title: "Warung Kustomisasi",
                items: {
                    'map_space': { name: "Tema Luar Angkasa", icon: "🌌", price: 500, type: "map_theme" },
                    'map_ocean': { name: "Tema Bawah Laut", icon: "🌊", price: 500, type: "map_theme" },
                    'palette_sunset': { name: "Palet Matahari Terbenam", icon: "🌅", price: 300, type: "ui_palette" },
                    'palette_neon': { name: "Palet Neon", icon: "🌃", price: 300, type: "ui_palette" },
                }
            },
            powerup: {
                title: "Pasar Kekuatan",
                items: {
                    'double_points': { name: "Pengganda Poin (10 Menit)", icon: "⚡", price: 200, type: "consumable" },
                    'fifty_fifty': { name: "Penghapus Opsi 50/50", icon: "❓", price: 75, type: "consumable" },
                    'extra_time': { name: "Waktu Tambahan (+15s)", icon: "⏱️", price: 100, type: "consumable" },
                }
            },
            mascot: {
                title: "Butik Cendekia",
                items: {
                    'monocle': { name: "Kacamata Monocle", icon: "🧐", price: 250, type: "mascot_accessory" },
                    'grad_hat': { name: "Topi Wisuda", icon: "🎓", price: 300, type: "mascot_accessory" },
                }
            }
        };

        const mascotSVG = `<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><g><path d="M50,15 C25,15 10,35 10,55 C10,80 25,95 50,95 C75,95 90,80 90,55 C90,35 75,15 50,15 Z" fill="#4CAF50"/><path d="M35,45 C40,40 50,40 55,45 C60,50 60,60 55,65 L45,65 C40,60 40,50 35,45 Z" fill="#388E3C" transform="translate(-15, 0)"/><path d="M65,45 C60,40 50,40 45,45 C40,50 40,60 45,65 L55,65 C60,60 60,50 65,45 Z" fill="#388E3C" transform="translate(15, 0)"/><circle cx="32" cy="52" r="18" fill="white"/><circle cx="68" cy="52" r="18" fill="white"/><circle cx="33" cy="53" r="8" fill="black"/><circle cx="67" cy="53" r="8" fill="black"/><path d="M50,65 C55,75 45,75 50,65 L52,70 L48,70 Z" fill="#FFC107"/><path d="M20,15 Q30,5 40,15" stroke="#388E3C" stroke-width="4" fill="none" stroke-linecap="round"/><path d="M80,15 Q70,5 60,15" stroke="#388E3C" stroke-width="4" fill="none" stroke-linecap="round"/></g></svg>`;

        // --- DATABASE LENGKAP MATERI ---
        const edukasiData = {
            sd: {
                dunia: {
                    matematika_dasar: { namaDunia: "Kerajaan Angka", warna: "blue", icon: "🔢", deskripsi: "Jelajahi dunia angka, penjumlahan, dan perkalian yang seru!", subMateri: { penjumlahan: { judul: "Penjumlahan Dasar", konten: "<p>Penjumlahan adalah cara menggabungkan dua angka atau lebih. Contoh: 2 + 3 = 5. Ayo coba beberapa soal!</p>", funFact: "Tahukah kamu, simbol tambah (+) sudah digunakan selama lebih dari 500 tahun!", kuis: [{ type: "pilihan-ganda", pertanyaan: "Berapakah hasil dari 7 + 5?", pilihan: ["10", "11", "12"], jawaban: "12", hint:"Coba hitung jari tanganmu ditambah dua jari lagi." }] }, perkalian: { judul: "Perkalian Sederhana", konten: "<p>Perkalian adalah penjumlahan berulang. Contoh: 3 x 4 sama dengan 4 + 4 + 4 = 12.</p>", funFact: "Orang Mesir kuno sudah menggunakan perkalian untuk membangun piramida.", kuis: [{ type: "pilihan-ganda", pertanyaan: "Berapakah hasil dari 6 x 3?", pilihan: ["18", "15", "24"], jawaban: "18", hint:"Ini sama dengan menjumlahkan 6 sebanyak 3 kali." }] } } },
                    bahasa_indonesia_sd: { namaDunia: "Pulau Kata", warna: "green", icon: "✍️", deskripsi: "Belajar membaca, menulis, dan menyusun kalimat dengan benar.", subMateri: { alfabet: { judul: "Mengenal Alfabet", konten: "<p>Alfabet adalah kumpulan huruf dari A sampai Z. Setiap huruf memiliki bunyinya sendiri. Mari kita ucapkan bersama-sama!</p>", funFact: "Bahasa Indonesia menggunakan 26 huruf alfabet Latin, sama seperti Bahasa Inggris.", kuis: [{ type: "pilihan-ganda", pertanyaan: "Huruf apa yang datang setelah huruf 'G'?", pilihan: ["F", "H", "I"], jawaban: "H", hint:"Urutannya adalah E, F, G, ..." }] }, kalimat: { judul: "Membuat Kalimat", konten: "<p>Kalimat adalah rangkaian kata yang memiliki arti. Contoh: 'Budi bermain bola'. Kalimat sederhana terdiri dari Subjek-Predikat-Objek.</p>", funFact: "Tanda titik (.) digunakan untuk mengakhiri sebuah kalimat berita.", kuis: [{ type: "pilihan-ganda", pertanyaan: "Manakah yang merupakan kalimat yang benar?", pilihan: ["Makan nasi saya", "Saya makan nasi", "Nasi saya makan"], jawaban: "Saya makan nasi", hint:"Urutan yang benar biasanya adalah Siapa -> Melakukan Apa -> Terhadap Apa." }] } } },
                    ipa_sd: { namaDunia: "Taman Sains", warna: "yellow", icon: "🌿", deskripsi: "Pelajari tentang hewan, tumbuhan, dan alam sekitar kita.", subMateri: { hewan: { judul: "Mengenal Hewan", konten: "<p>Ada banyak jenis hewan di dunia. Ada yang hidup di darat, air, dan udara. Hewan pemakan daging disebut karnivora, pemakan tumbuhan disebut herbivora.</p>", funFact: "Gajah adalah satu-satunya mamalia yang tidak bisa melompat!", kuis: [{ type: "pilihan-ganda", pertanyaan: "Sapi adalah contoh hewan pemakan...", pilihan: ["Daging", "Tumbuhan", "Segalanya"], jawaban: "Tumbuhan", hint:"Sapi makan rumput di ladang." }] } } },
                    literasi_digital_sd: { namaDunia: "Benteng Digital", warna: "cyan", icon: "💻", deskripsi: "Belajar aman dan cerdas saat menggunakan internet.", subMateri: { keamanan_online: { judul: "Aman di Dunia Maya", konten: "<p>Internet itu menyenangkan, tapi kita harus hati-hati. Jangan berikan informasi pribadi seperti alamat rumah atau nomor telepon kepada orang asing. Selalu bilang ke orang tua jika ada yang membuatmu tidak nyaman.</p>", funFact: "Kata sandi yang kuat biasanya terdiri dari campuran huruf besar, huruf kecil, angka, dan simbol!", kuis: [{ type: "pilihan-ganda", pertanyaan: "Informasi apa yang TIDAK boleh kamu bagikan di internet?", pilihan: ["Nama panggilan", "Hobi", "Alamat rumah"], jawaban: "Alamat rumah", hint:"Informasi pribadi harus dijaga kerahasiaannya untuk keamanan." }] } } },
                    seni_rupa_sd: { namaDunia: "Galeri Warna", warna: "rose", icon: "🎨", deskripsi: "Mengenal warna, bentuk, dan cara menggambar.", subMateri: { warna_primer: { judul: "Warna Primer", konten: "<p>Warna primer adalah warna dasar yang tidak bisa dibuat dari campuran warna lain. Ada tiga warna primer: Merah, Kuning, dan Biru. Dengan mencampur ketiganya, kita bisa membuat banyak warna lain!</p>", funFact: "Mata manusia bisa membedakan sekitar 10 juta warna yang berbeda!", kuis: [{ type: "pilihan-ganda", pertanyaan: "Manakah yang BUKAN termasuk warna primer?", pilihan: ["Merah", "Hijau", "Biru"], jawaban: "Hijau", hint:"Hijau dibuat dari campuran warna primer lain." }] } } },
                    tata_surya_sd: { namaDunia: "Tata Surya Cilik", warna: "indigo", icon: "🪐", deskripsi: "Ayo berkeliling ke planet-planet tetangga Bumi!", subMateri: { mengenal_planet: { judul: "Mengenal Planet", konten: "<p>Di tata surya kita ada 8 planet: Merkurius, Venus, Bumi, Mars, Jupiter, Saturnus, Uranus, dan Neptunus. Jupiter adalah yang terbesar.</p>", funFact: "Sehari di Venus lebih lama daripada setahun di Venus!", kuis: [{ type: "pilihan-ganda", pertanyaan: "Planet manakah yang memiliki cincin yang sangat indah dan terkenal?", pilihan: ["Mars", "Bumi", "Saturnus"], jawaban: "Saturnus", hint: "Planet ini adalah yang terbesar kedua setelah Jupiter." }] }}},
                    pahlawan_sd: { namaDunia: "Pahlawan Indonesiaku", warna: "red", icon: "🇮🇩", deskripsi: "Kenali jasa para pahlawan hebat yang telah berjuang untuk kemerdekaan.", subMateri: { kihajar_dewantara: { judul: "Ki Hajar Dewantara", konten: "<p>Ki Hajar Dewantara adalah Bapak Pendidikan Nasional. Beliau mendirikan sekolah Taman Siswa dan menciptakan semboyan 'Tut Wuri Handayani'.</p>", funFact: "Hari Pendidikan Nasional di Indonesia, 2 Mei, adalah hari kelahiran Ki Hajar Dewantara.", kuis: [{ type: "pilihan-ganda", pertanyaan: "Apa nama sekolah yang didirikan oleh Ki Hajar Dewantara?", pilihan: ["Taman Kanak-Kanak", "Taman Siswa", "Taman Bermain"], jawaban: "Taman Siswa", hint: "Namanya berarti 'Taman para Murid'." }] }}}
                }
            },
            smp: {
                dunia: {
                    ips_smp: { namaDunia: "Jejak Sejarah", warna: "orange", icon: "📜", deskripsi: "Menelusuri kerajaan-kerajaan kuno dan sejarah kemerdekaan.", subMateri: { kerajaan_nusantara: { judul: "Kerajaan Nusantara", konten: "<p>Indonesia memiliki sejarah kerajaan besar seperti Majapahit dan Sriwijaya. Majapahit terkenal dengan Sumpah Palapa dari Gajah Mada.</p>", funFact: "Candi Borobudur, peninggalan Kerajaan Mataram Kuno, adalah candi Buddha terbesar di dunia.", kuis: [{ type: "pilihan-ganda", pertanyaan: "Siapakah patih terkenal dari Kerajaan Majapahit?", pilihan: ["Hayam Wuruk", "Raden Wijaya", "Gajah Mada"], jawaban: "Gajah Mada", hint:"Namanya berhubungan dengan hewan besar yang memiliki belalai." }] } } },
                    biologi_smp: { namaDunia: "Laboratorium Kehidupan", warna: "teal", icon: "🔬", deskripsi: "Mempelajari sel, ekosistem, dan tubuh manusia.", subMateri: { sel: { judul: "Dasar-Dasar Sel", konten: "<p>Sel adalah unit terkecil dari makhluk hidup. Tumbuhan dan hewan memiliki sel, tetapi strukturnya sedikit berbeda. Sel tumbuhan memiliki dinding sel yang membuatnya kaku.</p>", funFact: "Tubuh manusia dewasa terdiri dari sekitar 37 triliun sel!", kuis: [{ type: "pilihan-ganda", pertanyaan: "Bagian sel yang berfungsi sebagai pusat kendali adalah...", pilihan: ["Membran sel", "Sitoplasma", "Inti sel (Nukleus)"], jawaban: "Inti sel (Nukleus)", hint:"Bagian ini sering disebut sebagai 'otak' dari sel." }] } } },
                    geografi_smp: { namaDunia: "Atlas Dunia", warna: "emerald", icon: "🗺️", deskripsi: "Menjelajahi benua, samudra, dan iklim di seluruh dunia.", subMateri: { benua_asia: { judul: "Benua Asia", konten: "<p>Asia adalah benua terbesar dan terpadat di dunia. Gunung tertinggi di dunia, Gunung Everest, dan laut terdalam, Palung Mariana, keduanya berada di Asia. Indonesia adalah bagian dari benua Asia, tepatnya Asia Tenggara.</p>", funFact: "Lebih dari 60% populasi dunia tinggal di benua Asia!", kuis: [{ type: "pilihan-ganda", pertanyaan: "Gunung tertinggi di dunia yang terletak di Asia adalah...", pilihan: ["Gunung Fuji", "Gunung Everest", "Gunung Kilimanjaro"], jawaban: "Gunung Everest", hint:"Puncaknya berada di pegunungan Himalaya." }] } } },
                    ekonomi_smp: { namaDunia: "Plaza Finansial", warna: "lime", icon: "🏦", deskripsi: "Memahami dasar-dasar uang, tabungan, dan jual beli.", subMateri: { menabung: { judul: "Pentingnya Menabung", konten: "<p>Menabung adalah menyisihkan sebagian uang yang kita miliki untuk disimpan. Ini penting untuk kebutuhan masa depan atau saat ada keperluan mendadak. Kita bisa menabung di celengan atau di bank.</p>", funFact: "Sistem barter (tukar-menukar barang) adalah bentuk 'ekonomi' tertua sebelum uang ditemukan.", kuis: [{ type: "pilihan-ganda", pertanyaan: "Kegiatan menyisihkan uang untuk disimpan disebut...", pilihan: ["Belanja", "Berinvestasi", "Menabung"], jawaban: "Menabung", hint:"Kegiatan ini biasanya dilakukan agar uang terkumpul." }] } } },
                    laut_smp: { namaDunia: "Ekspedisi Bawah Laut", warna: "cyan", icon: "🐠", deskripsi: "Selami keindahan dan misteri ekosistem laut, dari terumbu karang hingga palung terdalam.", subMateri: { zona_laut: { judul: "Zona Laut", konten: "<p>Lautan terbagi menjadi beberapa zona berdasarkan kedalaman. Zona paling atas disebut zona epipelagik, tempat sebagian besar kehidupan laut berada.</p>", funFact: "Tekanan di Palung Mariana setara dengan 50 pesawat jet jumbo yang ditumpuk di atas tubuhmu!", kuis: [{ type: "pilihan-ganda", pertanyaan: "Zona laut teratas yang paling banyak menerima sinar matahari disebut...", pilihan: ["Zona Hadal", "Zona Abisal", "Zona Epipelagik"], jawaban: "Zona Epipelagik", hint: "'Epi' berarti 'atas' atau 'permukaan'." }] }}},
                    logika_smp: { namaDunia: "Bengkel Logika (Dasar Coding)", warna: "slate", icon: "🤖", deskripsi: "Pelajari cara berpikir seperti komputer! Pahami konsep dasar algoritma.", subMateri: { algoritma: { judul: "Apa itu Algoritma?", konten: "<p>Algoritma adalah serangkaian instruksi atau langkah-langkah yang jelas dan terurut untuk menyelesaikan suatu masalah. Contoh sederhana algoritma adalah resep masakan.</p>", funFact: "Istilah 'algoritma' berasal dari nama seorang matematikawan Persia abad ke-9, Al-Khawarizmi.", kuis: [{ type: "pilihan-ganda", pertanyaan: "Manakah contoh terbaik dari sebuah algoritma dalam kehidupan sehari-hari?", pilihan: ["Membaca puisi", "Menonton film", "Langkah-langkah membuat kopi"], jawaban: "Langkah-langkah membuat kopi", hint: "Cari yang memiliki urutan langkah yang jelas." }] }}}
                }
            },
            sma: {
                dunia: {
                    fisika_sma: { namaDunia: "Galaksi Fisika", warna: "purple", icon: "⚛️", deskripsi: "Mengungkap hukum alam, dari gerak hingga listrik.", subMateri: { hukum_newton: { judul: "Hukum Gerak Newton", konten: "<p>Hukum Newton tentang gerak ada tiga. Hukum I (Inersia), Hukum II (F=ma), dan Hukum III (Aksi-Reaksi). Hukum ini menjelaskan bagaimana benda bergerak.</p>", funFact: "Isaac Newton menemukan hukum gravitasi saat melihat sebuah apel jatuh dari pohon.", kuis: [{ type: "pilihan-ganda", pertanyaan: "Bunyi dari Hukum III Newton adalah...", pilihan: ["Gaya sebanding dengan massa dan percepatan", "Setiap aksi akan menimbulkan reaksi yang sama besar dan berlawanan arah", "Benda akan tetap diam atau bergerak lurus beraturan jika resultan gaya nol"], jawaban: "Setiap aksi akan menimbulkan reaksi yang sama besar dan berlawanan arah", hint:"Ini tentang hubungan timbal balik antara dua gaya." }] } } },
                    kimia_sma: { namaDunia: "Dunia Molekul", warna: "pink", icon: "⚗️", deskripsi: "Pelajari tentang atom, ikatan kimia, dan reaksi-reaksi menakjubkan.", subMateri: { ikatan_kimia: { judul: "Ikatan Kimia", konten: "<p>Atom-atom bergabung membentuk molekul melalui ikatan kimia. Ada ikatan ion (serah terima elektron) dan ikatan kovalen (pemakaian bersama elektron).</p>", funFact: "Air (H₂O) adalah contoh molekul dengan ikatan kovalen.", kuis: [{ type: "pilihan-ganda", pertanyaan: "Jenis ikatan pada garam dapur (NaCl) adalah...", pilihan: ["Kovalen", "Ion", "Logam"], jawaban: "Ion", hint:"Terjadi antara unsur logam (Na) dan non-logam (Cl)." }] } } },
                    astronomi_sma: { namaDunia: "Observatorium Bintang", warna: "indigo", icon: "🔭", deskripsi: "Menjelajahi planet, bintang, dan misteri alam semesta.", subMateri: { tata_surya: { judul: "Tata Surya Kita", konten: "<p>Tata surya kita terdiri dari Matahari sebagai pusat dan delapan planet yang mengorbitnya: Merkurius, Venus, Bumi, Mars, Jupiter, Saturnus, Uranus, dan Neptunus. Jupiter adalah planet terbesar di tata surya.</p>", funFact: "Satu tahun di Merkurius (periode orbitnya) hanya berlangsung selama 88 hari Bumi!", kuis: [{ type: "pilihan-ganda", pertanyaan: "Planet manakah yang dikenal sebagai 'Planet Merah'?", pilihan: ["Venus", "Mars", "Jupiter"], jawaban: "Mars", hint:"Warnanya kemerahan karena kandungan besi oksida di permukaannya." }] } } },
                    sosiologi_sma: { namaDunia: "Arena Sosial", warna: "fuchsia", icon: "👨‍👩‍👧‍👦", deskripsi: "Mempelajari interaksi, kelompok, dan struktur dalam masyarakat.", subMateri: { interaksi_sosial: { judul: "Interaksi Sosial", konten: "<p>Interaksi sosial adalah hubungan timbal balik antara individu dengan individu, individu dengan kelompok, atau kelompok dengan kelompok. Syarat terjadinya interaksi sosial adalah adanya kontak sosial dan komunikasi.</p>", funFact: "Tertawa adalah bentuk komunikasi sosial universal yang dapat dipahami di hampir semua budaya.", kuis: [{ type: "pilihan-ganda", pertanyaan: "Dua syarat utama terjadinya interaksi sosial adalah...", pilihan: ["Kontak dan Komunikasi", "Akomodasi dan Asimilasi", "Status dan Peran"], jawaban: "Kontak dan Komunikasi", hint:"Satu adalah tentang 'sentuhan' fisik/non-fisik, yang lain tentang penyampaian pesan." }] } } },
                    sastra_sma: { namaDunia: "Panggung Sastra", warna: "stone", icon: "✒️", deskripsi: "Analisis karya-karya sastra legendaris Indonesia dan dunia.", subMateri: { balai_pustaka: { judul: "Angkatan Balai Pustaka", konten: "<p>Angkatan Balai Pustaka (1920-an) adalah periode sastra modern yang karyanya banyak mengangkat tema adat, kawin paksa, dan konflik tradisi vs modernitas. Contoh: 'Sitti Nurbaya'.</p>", funFact: "Roman 'Sitti Nurbaya' begitu populernya hingga frasa 'Kasih Tak Sampai' menjadi ungkapan umum.", kuis: [{ type: "pilihan-ganda", pertanyaan: "Tema utama yang sering diangkat dalam karya sastra Angkatan Balai Pustaka adalah...", pilihan: ["Perjuangan kemerdekaan", "Konflik adat dan modernitas", "Kehidupan metropolitan"], jawaban: "Konflik adat dan modernitas", hint: "Fokus pada gesekan antara nilai-nilai lama dan baru." }] }}},
                    ekraf_sma: { namaDunia: "Studio Ekonomi Kreatif", warna: "amber", icon: "💡", deskripsi: "Jelajahi industri yang lahir dari kreativitas, seperti film, musik, dan game.", subMateri: { haki: { judul: "Hak Kekayaan Intelektual (HAKI)", konten: "<p>HAKI adalah hak hukum yang melindungi karya-karya dari hasil pemikiran manusia. Jenisnya antara lain Hak Cipta (lagu, buku), Paten (penemuan), dan Merek Dagang (logo).</p>", funFact: "Karakter Mickey Mouse seharusnya sudah menjadi domain publik, tetapi Disney berhasil melobi perpanjangan UU hak cipta.", kuis: [{ type: "pilihan-ganda", pertanyaan: "Jika kamu menulis sebuah novel, jenis perlindungan HAKI yang paling tepat adalah...", pilihan: ["Paten", "Merek Dagang", "Hak Cipta"], jawaban: "Hak Cipta", hint: "Ini melindungi karya seni dan literatur." }] }}}
                }
            },
            kuliah: {
                dunia: {
                    filsafat: { namaDunia: "Alam Pikiran", warna: "slate", icon: "🧠", deskripsi: "Menjelajahi pertanyaan-pertanyaan mendasar tentang eksistensi dan pengetahuan.", subMateri: { stoikisme: { judul: "Pengantar Stoikisme", konten: "<p>Stoikisme adalah filsafat kuno yang mengajarkan kebajikan, nalar, dan hidup selaras dengan alam. Fokus pada apa yang bisa kita kendalikan dan menerima apa yang tidak bisa.</p>", funFact: "Marcus Aurelius, seorang Kaisar Romawi, adalah salah satu filsuf Stoik yang paling terkenal.", kuis: [{ type: "pilihan-ganda", pertanyaan: "Prinsip utama Stoikisme adalah fokus pada hal yang dapat kita...", pilihan: ["Ubah", "Kontrol", "Inginkan"], jawaban: "Kontrol", hint:"Ini adalah tentang membedakan apa yang ada di dalam dan di luar kekuatan kita." }] } } },
                    ekonomi_mikro: { namaDunia: "Pasar dan Individu", warna: "red", icon: "📈", deskripsi: "Menganalisis perilaku konsumen, produsen, dan struktur pasar.", subMateri: { permintaan_penawaran: { judul: "Permintaan & Penawaran", konten: "<p>Hukum permintaan menyatakan bahwa ketika harga naik, jumlah permintaan turun. Hukum penawaran menyatakan bahwa ketika harga naik, jumlah penawaran juga naik. Titik temu keduanya disebut ekuilibrium.</p>", funFact: "Konsep 'invisible hand' atau tangan tak terlihat diperkenalkan oleh Adam Smith, bapak ekonomi modern.", kuis: [{ type: "pilihan-ganda", pertanyaan: "Apa yang terjadi pada jumlah permintaan jika harga sebuah barang turun?", pilihan: ["Naik", "Turun", "Tetap"], jawaban: "Naik", hint:"Orang cenderung membeli lebih banyak jika harganya lebih murah." }] } } },
                    psikologi: { namaDunia: "Labirin Kesadaran", warna: "violet", icon: "🧘", deskripsi: "Memahami pikiran, emosi, dan perilaku manusia.", subMateri: { memori: { judul: "Cara Kerja Memori", konten: "<p>Memori manusia secara umum dibagi menjadi tiga tahap: encoding (memasukkan informasi), storage (menyimpan), dan retrieval (mengambil kembali). Memori jangka pendek memiliki kapasitas terbatas, sedangkan memori jangka panjang bisa sangat besar.</p>", funFact: "Efek 'deja vu' (merasa pernah mengalami sesuatu) masih menjadi misteri besar dalam neurosains dan psikologi.", kuis: [{ type: "pilihan-ganda", pertanyaan: "Tahap pertama dalam proses memori adalah...", pilihan: ["Storage", "Retrieval", "Encoding"], jawaban: "Encoding", hint:"Ini adalah proses mengubah persepsi menjadi informasi yang bisa disimpan." }] } } },
                    hukum: { namaDunia: "Gedung Keadilan", warna: "stone", icon: "⚖️", deskripsi: "Mengenal konsep dasar hukum, norma, dan peradilan.", subMateri: { hierarki_hukum: { judul: "Hierarki Peraturan", konten: "<p>Di Indonesia, hierarki peraturan perundang-undangan menempatkan UUD 1945 sebagai hukum tertinggi, diikuti oleh Ketetapan MPR, Undang-Undang/Perppu, Peraturan Pemerintah, Peraturan Presiden, hingga Peraturan Daerah.</p>", funFact: "Konsep 'praduga tak bersalah' berarti seseorang dianggap tidak bersalah sampai pengadilan membuktikan sebaliknya.", kuis: [{ type: "pilihan-ganda", pertanyaan: "Hukum tertinggi dalam tata urutan perundang-undangan di Indonesia adalah...", pilihan: ["Undang-Undang", "UUD 1945", "Peraturan Pemerintah"], jawaban: "UUD 1945", hint:"Ini adalah konstitusi negara." }] } } },
                    ai_kuliah: { namaDunia: "Inkubator Kecerdasan Buatan (AI)", warna: "violet", icon: "🧠", deskripsi: "Kenali konsep dasar di balik AI, dari Machine Learning hingga Neural Networks.", subMateri: { ml_vs_ai: { judul: "Machine Learning vs AI", konten: "<p>AI adalah konsep luas tentang mesin cerdas. Machine Learning (ML) adalah *cabang* dari AI di mana mesin belajar dari data. Jadi, semua ML adalah AI, tetapi tidak semua AI adalah ML.</p>", funFact: "Tes Turing, diusulkan pada tahun 1950, adalah sebuah tes untuk menentukan kecerdasan sebuah mesin.", kuis: [{ type: "pilihan-ganda", pertanyaan: "Sistem rekomendasi film di Netflix adalah contoh penerapan dari...", pilihan: ["Kecerdasan Umum Buatan", "Machine Learning", "Robotika Fisik"], jawaban: "Machine Learning", hint: "Sistem ini belajar dari riwayat tontonan Anda." }] }}},
                    antropologi_kuliah: { namaDunia: "Forum Antropologi", warna: "orange", icon: "🗿", deskripsi: "Pelajari keragaman budaya manusia, ritual, dan sistem sosial.", subMateri: { etnosentrisme: { judul: "Etnosentrisme vs Relativisme Budaya", konten: "<p>Etnosentrisme adalah menilai budaya lain menggunakan standar budaya sendiri. Relativisme budaya adalah prinsip memahami budaya berdasarkan konteksnya sendiri.</p>", funFact: "Antropolog Franz Boas adalah pelopor utama konsep relativisme budaya untuk melawan rasisme ilmiah.", kuis: [{ type: "pilihan-ganda", pertanyaan: "Menganggap cara makan dengan tangan lebih rendah dari sendok garpu adalah contoh...", pilihan: ["Relativisme Budaya", "Akulturasi", "Etnosentrisme"], jawaban: "Etnosentrisme", hint: "Ini melibatkan sikap memandang budaya sendiri sebagai superior." }] }}}
                }
            }
        };

        function generateBadges() {
            for (const jenjang in edukasiData) {
                const jenjangData = edukasiData[jenjang];
                if (!jenjangData.badges) jenjangData.badges = {};
                for (const duniaId in jenjangData.dunia) {
                    const dunia = jenjangData.dunia[duniaId];
                    jenjangData.badges[duniaId] = {
                        id: duniaId,
                        title: `Pakar ${dunia.namaDunia}`,
                        description: `Menyelesaikan semua materi di ${dunia.namaDunia}.`,
                        icon: dunia.icon
                    };
                }
                const jenjangTitle = { sd: "SD", smp: "SMP", sma: "SMA", kuliah: "Kuliah" }[jenjang];
                jenjangData.badges['cendekia'] = {
                    id: 'cendekia',
                    title: `Cendekia ${jenjangTitle}`,
                    description: `Menyelesaikan 100% materi di jenjang ${jenjangTitle}!`,
                    icon: '🎓'
                };
            }
        }
        generateBadges();


        // --- Variabel & State Aplikasi ---
        const domElements = { 
            screens: document.querySelectorAll('.screen'), 
            modals: document.querySelectorAll('.modal-overlay'),
            loadingScreen: document.getElementById('loading-screen'),
            userListContainer: document.getElementById('user-list-container'), 
            addNewUserBtn: document.getElementById('add-new-user-btn'), 
            playerNameInput: document.getElementById('player-name-input'), 
            avatarSelectionContainer: document.getElementById('avatar-selection-container'),
            nextToLevelBtn: document.getElementById('next-to-level-btn'), 
            cancelNewUserBtn: document.getElementById('cancel-new-user-btn'), 
            jenjangPromptName: document.getElementById('jenjang-prompt-name'), 
            welcomeMessage: document.getElementById('welcome-message'), 
            pointsDisplay: document.getElementById('points-display'), 
            userAvatarHeader: document.getElementById('user-avatar-header'), 
            duniaContainer: document.getElementById('dunia-container'), 
            submateriContainer: document.getElementById('submateri-container'), 
            submateriTitle: document.getElementById('submateri-title'), 
            materiContent: document.getElementById('materi-content'), 
            backToWorldsBtn: document.getElementById('back-to-worlds-btn'), 
            backToSubmateriBtn: document.getElementById('back-to-submateri-btn'), 
            settingsBtn: document.getElementById('settings-btn'), 
            achievementsBtn: document.getElementById('achievements-btn'), 
            closeSettingsBtn: document.getElementById('close-settings-btn'), 
            editNameInput: document.getElementById('edit-name-input'), 
            saveNameBtn: document.getElementById('save-name-btn'), 
            changeJenjangSelect: document.getElementById('change-jenjang-select'),
            soundToggleBtn: document.getElementById('sound-toggle'),
            themeSelector: document.getElementById('theme-selector'),
            resetProgressBtn: document.getElementById('reset-progress-btn'), 
            resetUsernameConfirm: document.getElementById('reset-username-confirm'), 
            cancelResetBtn: document.getElementById('cancel-reset-btn'), 
            confirmResetBtn: document.getElementById('confirm-reset-btn'), 
            funFactText: document.getElementById('fun-fact-text'), 
            closeFunFactBtn: document.getElementById('close-fun-fact-btn'), 
            achievementsList: document.getElementById('achievements-list'), 
            closeAchievementsBtn: document.getElementById('close-achievements-btn'), 
            certificateName: document.getElementById('certificate-name'), 
            closeCertificateBtn: document.getElementById('close-certificate-btn'),
            leaderboardBtn: document.getElementById('leaderboard-btn'),
            leaderboardList: document.getElementById('leaderboard-list'),
            closeLeaderboardBtn: document.getElementById('close-leaderboard-btn'),
            dailyMissionBtn: document.getElementById('daily-mission-btn'),
            dailyMissionText: document.getElementById('daily-mission-text'),
            missionProgressBar: document.getElementById('mission-progress-bar'),
            claimMissionRewardBtn: document.getElementById('claim-mission-reward-btn'),
            closeDailyMissionBtn: document.getElementById('close-daily-mission-btn'),
            closeDailyBonusBtn: document.getElementById('close-daily-bonus-btn'),
            avatarShopContainer: document.getElementById('avatar-shop-container'),
            closeAvatarShopBtn: document.getElementById('close-avatar-shop-btn'),
            shopPointsDisplay: document.getElementById('shop-points-display'),
            pointAnimationContainer: document.getElementById('point-animation-container'),
            streakDisplay: document.getElementById('streak-display'),
            dailyBonusAmount: document.getElementById('daily-bonus-amount'),
            dailyStreakBonusText: document.getElementById('daily-streak-bonus-text'),
            shareProgressBtn: document.getElementById('share-progress-btn'),
            mascotTipContainer: document.getElementById('mascot-tip-container'),
            musicToggleBtn: document.getElementById('music-toggle'),
            backgroundMusic: document.getElementById('background-music'),
            searchBar: document.getElementById('search-bar'),
            wordOfTheDay: document.getElementById('word-of-the-day'),
            reviewModeBtn: document.getElementById('review-mode-btn'),
            timedChallengeBtn: document.getElementById('timed-challenge-btn'),
            timedChallengeModal: document.getElementById('timed-challenge-modal'),
            challengeTimer: document.getElementById('challenge-timer'),
            challengeQuestionArea: document.getElementById('challenge-question-area'),
            challengeFeedback: document.getElementById('challenge-feedback'),
            closeTimedChallengeBtn: document.getElementById('close-timed-challenge-btn'),
            statsModal: document.getElementById('stats-modal'),
            statsUsername: document.getElementById('stats-username'),
            statsContent: document.getElementById('stats-content'),
            closeStatsBtn: document.getElementById('close-stats-btn'),
            userTitleDisplay: document.getElementById('user-title-display'),
            genericShopTitle: document.getElementById('generic-shop-title'),
            genericShopContainer: document.getElementById('generic-shop-container'),
            genericShopPoints: document.getElementById('generic-shop-points')
        };

        let userProfiles = [], currentUserIndex = -1, activeUser = null, currentDuniaId = null, currentSubmateriId = null, selectedAvatarId = null, timedChallengeInterval = null;
        let dailyBonusWorldId = null;
        const sounds = { 
            click: new Tone.Synth({ oscillator: { type: "sine" }, envelope: { attack: 0.01, decay: 0.2, sustain: 0, release: 0.1 } }).toDestination(), 
            correct: new Tone.Synth({ oscillator: { type: "triangle" }, envelope: { attack: 0.01, decay: 0.3, sustain: 0.1, release: 0.2 } }).toDestination(), 
            wrong: new Tone.Synth({ oscillator: { type: "square" }, envelope: { attack: 0.01, decay: 0.5, sustain: 0, release: 0.2 } }).toDestination(), 
            badge: new Tone.Synth({ oscillator: { type: "sawtooth" }, envelope: { attack: 0.1, decay: 0.5, sustain: 0.2, release: 0.5 } }).toDestination(),
            open: new Tone.Synth({ oscillator: { type: "sine" }, envelope: { attack: 0.01, decay: 0.1, sustain: 0, release: 0.1 } }).toDestination(),
            purchase: new Tone.Synth({ oscillator: { type: "triangle8" }, envelope: { attack: 0.01, decay: 0.4, sustain: 0.1, release: 0.2 } }).toDestination(),
            equip: new Tone.Synth({ oscillator: { type: "sine" }, envelope: { attack: 0.05, decay: 0.2, sustain: 0.2, release: 0.1 } }).toDestination(),
        };
        const colorMapping = { green: { bg: 'bg-green-100', text: 'text-green-800', border: 'border-green-400', progress: 'bg-green-500' }, emerald: { bg: 'bg-emerald-100', text: 'text-emerald-800', border: 'border-emerald-400', progress: 'bg-emerald-500' }, yellow: { bg: 'bg-yellow-100', text: 'text-yellow-800', border: 'border-yellow-400', progress: 'bg-yellow-500' }, amber: { bg: 'bg-amber-100', text: 'text-amber-800', border: 'border-amber-400', progress: 'bg-amber-500' }, blue: { bg: 'bg-blue-100', text: 'text-blue-800', border: 'border-blue-400', progress: 'bg-blue-500' }, purple: { bg: 'bg-purple-100', text: 'text-purple-800', border: 'border-purple-400', progress: 'bg-purple-500' }, violet: { bg: 'bg-violet-100', text: 'text-violet-800', border: 'border-violet-400', progress: 'bg-violet-500' }, red: { bg: 'bg-red-100', text: 'text-red-800', border: 'border-red-400', progress: 'bg-red-500' }, teal: { bg: 'bg-teal-100', text: 'text-teal-800', border: 'border-teal-400', progress: 'bg-teal-500' }, pink: { bg: 'bg-pink-100', text: 'text-pink-800', border: 'border-pink-400', progress: 'bg-pink-500' }, rose: { bg: 'bg-rose-100', text: 'text-rose-800', border: 'border-rose-400', progress: 'bg-rose-500' }, lime: { bg: 'bg-lime-100', text: 'text-lime-800', border: 'border-lime-400', progress: 'bg-lime-500' }, orange: { bg: 'bg-orange-100', text: 'text-orange-800', border: 'border-orange-400', progress: 'bg-orange-500' }, cyan: { bg: 'bg-cyan-100', text: 'text-cyan-800', border: 'border-cyan-400', progress: 'bg-cyan-500' }, indigo: { bg: 'bg-indigo-100', text: 'text-indigo-800', border: 'border-indigo-400', progress: 'bg-indigo-500' }, slate: { bg: 'bg-slate-100', text: 'text-slate-800', border: 'border-slate-400', progress: 'bg-slate-500' }, fuchsia: { bg: 'bg-fuchsia-100', text: 'text-fuchsia-800', border: 'border-fuchsia-400', progress: 'bg-fuchsia-500' }, stone: { bg: 'bg-stone-100', text: 'text-stone-800', border: 'border-stone-400', progress: 'bg-stone-500' }};

        // --- Fungsi-fungsi Aplikasi ---

        function createNewUser(name, avatarId) {
            const starterAvatars = Object.keys(avatarData).filter(id => avatarData[id].isStarter);
            const u = {
                id: Date.now(),
                name: name,
                avatarId: avatarId,
                jenjang: null,
                points: 0,
                progress: {},
                badges: {},
                dailyMission: {},
                lastLogin: null,
                loginStreak: 0, 
                unlockedAvatars: starterAvatars,
                stats: { correctAnswers: 0, wrongAnswers: 0, quizzesCompleted: 0 },
                settings: { soundOn: true, theme: 'light', musicOn: false },
                title: "Petualang Baru",
                unlockedTitles: ["Petualang Baru"],
                achievementProgress: {},
                inventory: {}
            };
            userProfiles.push(u);
            currentUserIndex = userProfiles.length - 1;
            activeUser = u;
            saveData();
            domElements.jenjangPromptName.textContent = `Hai ${activeUser.name}, ayo pilih jenjangmu!`;
            switchScreen('jenjang-screen');
        }

        function checkDailyLogin() {
            const today = new Date();
            const todayStr = today.toDateString();
            if (activeUser.lastLogin === todayStr) return;

            const yesterday = new Date(today);
            yesterday.setDate(today.getDate() - 1);
            
            if (activeUser.lastLogin === yesterday.toDateString()) {
                activeUser.loginStreak++;
            } else if (activeUser.lastLogin !== null) {
                activeUser.loginStreak = 1;
                 showMascotTip(`Semangat kembali, ${activeUser.name}! Lanjutkan petualanganmu setiap hari untuk bonus lebih besar!`);
            } else {
                 activeUser.loginStreak = 1;
            }
            
            const baseBonus = 50;
            const streakBonus = activeUser.loginStreak * 10;
            const totalBonus = baseBonus + streakBonus;

            activeUser.lastLogin = todayStr;
            addPoints(totalBonus, null, false);
            
            domElements.dailyBonusAmount.textContent = `${totalBonus} Poin`;
            if (activeUser.loginStreak > 1) {
                domElements.dailyStreakBonusText.textContent = `Bonus beruntun ${activeUser.loginStreak} hari: +${streakBonus} poin!`;
            } else {
                domElements.dailyStreakBonusText.textContent = "Selesaikan misimu dan kembali besok untuk bonus lebih besar!";
            }

            saveData();
            updateUI();
            showModal('daily-bonus-modal');
        }

        function updateUI() {
            if (!activeUser) return;
            domElements.welcomeMessage.textContent = `Halo, ${activeUser.name}!`;
            domElements.userTitleDisplay.textContent = activeUser.title;
            domElements.userAvatarHeader.innerHTML = avatarData[activeUser.avatarId].svg;
            domElements.streakDisplay.innerHTML = activeUser.loginStreak > 1 ? `🔥 ${activeUser.loginStreak}` : '';
            domElements.pointsDisplay.textContent = `💰 Poin: ${activeUser.points}`;
            setWordOfTheDay();
        }
        
        function showPointAnimation(text) {
            const animEl = document.createElement('div');
            animEl.className = 'point-animation';
            animEl.textContent = text;
            domElements.pointAnimationContainer.appendChild(animEl);
            setTimeout(() => {
                animEl.remove();
            }, 1500);
        }

        function addPoints(amount, duniaId = null, withAnimation = true) {
            if (!activeUser) return;
            let finalAmount = amount;
            if (duniaId && duniaId === dailyBonusWorldId && amount > 0) {
                finalAmount = Math.ceil(amount * 1.25); // Bonus 25%
            }
            activeUser.points += finalAmount;
            if(withAnimation) showPointAnimation(`+${finalAmount}${finalAmount > amount ? '🌟' : ''}`);
            saveData();
            updateUI();
        }

        function renderAvatarShop() {
            domElements.shopPointsDisplay.textContent = `💰 Poin Anda: ${activeUser.points}`;
            domElements.avatarShopContainer.innerHTML = '';
            Object.keys(avatarData).forEach(avatarId => {
                const avatar = avatarData[avatarId];
                const isOwned = activeUser.unlockedAvatars.includes(avatarId);
                const isEquipped = activeUser.avatarId === avatarId;
                
                const item = document.createElement('div');
                item.className = 'shop-item p-4 flex flex-col items-center justify-center';
                if (isOwned) item.classList.add('owned');
                if (isEquipped) item.classList.add('equipped');

                item.innerHTML = avatar.svg;

                if (!isOwned) {
                    item.classList.add('locked');
                    item.innerHTML += `<div class="price-tag">💰 ${avatar.price}</div>`;
                }
                
                item.addEventListener('click', () => {
                    if (isOwned) {
                        playSound('equip');
                        activeUser.avatarId = avatarId;
                        saveData();
                        updateUI();
                        renderAvatarShop();
                    } else {
                        if (activeUser.points >= avatar.price) {
                            playSound('purchase');
                            addPoints(-avatar.price, null, false);
                            activeUser.unlockedAvatars.push(avatarId);
                            saveData();
                            updateUI();
                            renderAvatarShop();
                        } else {
                            playSound('wrong');
                            showMascotTip("Duh, poinmu belum cukup untuk membeli avatar ini. Ayo selesaikan lebih banyak kuis!");
                        }
                    }
                });
                domElements.avatarShopContainer.appendChild(item);
            });
        }
        
        function handleQuizAnswer(element, answer, duniaId, submateriId, type, hintUsed) {
            const feedbackEl = document.getElementById('quiz-feedback');
            const isCompleted = activeUser.progress[activeUser.jenjang]?.[duniaId]?.[submateriId];

            let userAnswer;
            if (type === 'isi-jawaban') {
                userAnswer = element.value.trim();
            } else {
                userAnswer = element.textContent.trim();
            }

            const isCorrect = userAnswer.toLowerCase() === answer.toLowerCase();

            if (isCorrect) {
                playSound('correct');
                feedbackEl.textContent = 'Jawaban Benar! Kamu Hebat!';
                feedbackEl.className = 'mt-4 text-lg font-bold text-green-600';
                activeUser.stats.correctAnswers++;

                if (!isCompleted) {
                    const pointsEarned = hintUsed ? 5 : 10;
                    addPoints(pointsEarned, duniaId);
                    activeUser.progress[activeUser.jenjang][duniaId][submateriId] = true;
                    activeUser.stats.quizzesCompleted++;
                    updateDailyMissionProgress('quiz_completed', duniaId);
                    updateDailyMissionProgress('correct_answer');
                    checkAndAwardBadges();
                    saveData();
                }

                setTimeout(() => {
                    const materi = edukasiData[activeUser.jenjang].dunia[duniaId].subMateri[submateriId];
                    if (materi.funFact) {
                        document.getElementById('mascot-container').innerHTML = mascotSVG;
                        domElements.funFactText.textContent = materi.funFact;
                        showModal('fun-fact-modal');
                    } else {
                        renderSubMateri(duniaId);
                        switchScreen('submateri-screen');
                    }
                }, 1000);

            } else {
                playSound('wrong');
                activeUser.stats.wrongAnswers++;
                feedbackEl.textContent = 'Jawaban kurang tepat, coba lagi!';
                feedbackEl.className = 'mt-4 text-lg font-bold text-red-600';
                if (element.classList) {
                    element.classList.add('animate-shake');
                    setTimeout(() => element.classList.remove('animate-shake'), 500);
                }
                
                setTimeout(() => {
                    feedbackEl.textContent = `Jawaban yang benar adalah: ${answer}`;
                    domElements.materiContent.querySelectorAll('.quiz-option').forEach(btn => {
                        if (btn.textContent.trim().toLowerCase() === answer.toLowerCase()) {
                             btn.classList.add('bg-green-200', 'border-green-500');
                        }
                    });
                }, 1500);
            }

            domElements.materiContent.querySelectorAll('.quiz-option, #quiz-submit-btn, .hint-button').forEach(btn => btn.disabled = true);
        }
        
        function initializeApp() {
            setTimeout(() => {
                if (loadData()) { renderUserSelectionScreen(); } else { switchScreen('user-selection-screen'); setupNewUserScreen(); showMascotTip("Selamat datang di Petualangan Pengetahuan! Buat profil barumu untuk memulai."); }
            }, 500);
        }

        // --- Inisialisasi & Fungsi Helper ---
        function playSound(type) { if(!activeUser?.settings?.soundOn) return; Tone.start().catch(e=>console.log("Tone.js not started.")); try { if (type === 'correct') sounds.correct.triggerAttackRelease("C5", "8n"); else if (type === 'wrong') sounds.wrong.triggerAttackRelease("C3", "8n"); else if (type === 'badge') { sounds.badge.triggerAttackRelease("G4", "8n", Tone.now()); sounds.badge.triggerAttackRelease("C5", "8n", Tone.now() + 0.2); sounds.badge.triggerAttackRelease("E5", "8n", Tone.now() + 0.4); } else if (type === 'open') { sounds.open.triggerAttackRelease("A4", "16n"); } else if (type === 'purchase') { sounds.purchase.triggerAttackRelease("E5", "8n"); } else if (type === 'equip') { sounds.equip.triggerAttackRelease("C5", "4n"); } else sounds.click.triggerAttackRelease("C4", "8n"); } catch (e) { console.error("Sound play error:", e); } }
        function speak(text, lang = 'id-ID') { if ('speechSynthesis' in window) { speechSynthesis.cancel(); const utterance = new SpeechSynthesisUtterance(text); utterance.lang = lang; utterance.rate = 0.9; speechSynthesis.speak(utterance); } }
        function saveData() { if (currentUserIndex > -1) userProfiles[currentUserIndex] = activeUser; localStorage.setItem('petualanganPenggunaListUltimateV9', JSON.stringify(userProfiles)); }
        function loadData() { const d = localStorage.getItem('petualanganPenggunaListUltimateV9'); if (d) { userProfiles = JSON.parse(d); return userProfiles.length > 0; } return false; }
        function selectUser(idx) { currentUserIndex = idx; activeUser = userProfiles[idx]; if (!activeUser.jenjang) { domElements.jenjangPromptName.textContent = `Hai ${activeUser.name}, ayo pilih jenjangmu!`; switchScreen('jenjang-screen'); } else { applyTheme(activeUser.settings.theme); toggleMusic(activeUser.settings.musicOn); startSession(); } }
        function initializeProgressForJenjang(jenjang) { if (!edukasiData[jenjang] || !activeUser) return; if (!activeUser.progress) activeUser.progress = {}; if (!activeUser.badges) activeUser.badges = {}; if(!activeUser.stats) activeUser.stats = { correctAnswers: 0, wrongAnswers: 0, quizzesCompleted: 0 }; if (activeUser.progress[jenjang]) return; activeUser.progress[jenjang] = {}; activeUser.badges[jenjang] = []; for (const duniaId in edukasiData[jenjang].dunia) { activeUser.progress[jenjang][duniaId] = {}; for (const submateriId in edukasiData[jenjang].dunia[duniaId].subMateri) { activeUser.progress[jenjang][duniaId][submateriId] = false; } } saveData(); }
        function switchScreen(id) { domElements.screens.forEach(s => s.classList.remove('active')); document.getElementById(id).classList.add('active'); }
        function showModal(id) { playSound('open'); document.getElementById(id).classList.add('active'); }
        function hideModals() { domElements.modals.forEach(m => m.classList.remove('active')); }
        function startSession() { checkDailyLogin(); checkDailyMission(); setDailyBonusWorld(); updateUI(); renderDuniaMap(); switchScreen('map-screen'); }
        function applyTheme(theme) { document.body.className = theme === 'dark' ? 'dark' : ''; activeUser.settings.theme = theme; const buttons = domElements.themeSelector.querySelectorAll('button'); buttons.forEach(b => { b.classList.remove('bg-blue-200'); if(b.dataset.theme === theme) b.classList.add('bg-blue-200'); }); saveData(); }
        function renderUserSelectionScreen() { domElements.userListContainer.innerHTML = ''; userProfiles.forEach((user, index) => { const jenjangText = user.jenjang ? {sd: "SD", smp: "SMP", sma: "SMA", kuliah: "Kuliah"}[user.jenjang] : 'Baru'; const card = document.createElement('div'); card.className = 'user-card p-4 bg-white rounded-2xl shadow-lg text-center cursor-pointer card-hover'; const avatarHTML = avatarData[user.avatarId]?.svg || `<div class="avatar mx-auto mb-4 bg-gray-400 font-brand text-3xl">${user.name.charAt(0).toUpperCase()}</div>`; card.innerHTML = `${avatarHTML}<h3 class="font-bold text-xl">${user.name}</h3><p class="text-gray-500">${jenjangText} - ${user.points} Poin</p>`; card.addEventListener('click', () => { playSound('click'); selectUser(index); }); domElements.userListContainer.appendChild(card); }); switchScreen('user-selection-screen'); }
        function renderDuniaMap(filter = '') { const jenjang = activeUser.jenjang; const dataDunia = edukasiData[jenjang].dunia; domElements.duniaContainer.innerHTML = ''; 
            const completedWorlds = Object.keys(dataDunia).filter(duniaId => {
                const progress = activeUser.progress[jenjang]?.[duniaId] || {};
                const total = Object.keys(dataDunia[duniaId].subMateri).length;
                const completed = Object.values(progress).filter(Boolean).length;
                return total > 0 && completed === total;
            }).length;

            const worldsToShow = {...dataDunia};
            const hiddenWorldUnlocked = completedWorlds >= 3; 
            if (hiddenWorldUnlocked) {
                worldsToShow['dunia_tersembunyi'] = { namaDunia: "Dunia Tersembunyi", warna: "slate", icon: "🗝️", deskripsi: "Tantangan spesial lintas materi untuk para petualang sejati!", subMateri: { tantangan_1: { judul: "Tantangan Campuran 1", konten: "<p>Uji pengetahuanmu dari berbagai bidang!</p>", funFact: "Otak manusia lebih aktif saat tidur daripada saat menonton TV.", kuis: [{ type: "pilihan-ganda", pertanyaan: "Ibukota dari negara Australia adalah...", pilihan: ["Sydney", "Melbourne", "Canberra"], jawaban: "Canberra", hint:"Bukan kota yang paling terkenal." }] } } };
            }
        
            for (const duniaId in worldsToShow) { const dunia = worldsToShow[duniaId]; 
            if (filter && !dunia.namaDunia.toLowerCase().includes(filter.toLowerCase())) continue;
            const c = colorMapping[dunia.warna] || colorMapping.blue; const progress = activeUser.progress[jenjang]?.[duniaId] || {}; const total = Object.keys(dunia.subMateri).length; const completed = Object.values(progress).filter(Boolean).length; const percentage = total > 0 ? (completed / total) * 100 : 0; const card = document.createElement('div'); card.className = `p-6 rounded-2xl shadow-lg cursor-pointer card-hover border-4 ${c.border} flex flex-col relative`; card.style.backgroundColor = `var(--card-bg-color)`;
            let bonusBadge = '';
            if (duniaId === dailyBonusWorldId) {
                bonusBadge = '<div class="bonus-world-badge">BONUS!</div>';
            }
            card.innerHTML = `${bonusBadge}<div class="text-5xl text-center mb-4">${dunia.icon}</div><h3 class="font-brand text-2xl text-center ${c.text}">${dunia.namaDunia}</h3><p class="text-sm mt-2 text-center flex-grow min-h-[60px]">${dunia.deskripsi}</p><div class="mt-4"><div class="text-xs font-semibold text-center mb-1">${completed} / ${total} Selesai</div><div class="w-full bg-gray-200 rounded-full h-2.5"><div class="${c.progress} h-2.5 rounded-full" style="width: ${percentage}%;"></div></div></div>`; card.addEventListener('click', () => { playSound('click'); currentDuniaId = duniaId; renderSubMateri(duniaId); switchScreen('submateri-screen'); }); domElements.duniaContainer.appendChild(card); } }
        function renderSubMateri(duniaId) { 
            const isHiddenWorld = duniaId === 'dunia_tersembunyi';
            const dunia = isHiddenWorld ? { namaDunia: "Dunia Tersembunyi", warna: "slate", icon: "🗝️", subMateri: { tantangan_1: { judul: "Tantangan Campuran 1" } } } : edukasiData[activeUser.jenjang].dunia[duniaId];

            const colors = colorMapping[dunia.warna]; domElements.submateriTitle.textContent = dunia.namaDunia; domElements.submateriTitle.className = `font-brand text-4xl md:text-5xl text-center mb-10 ${colors.text}`; domElements.submateriContainer.innerHTML = ''; for (const submateriId in dunia.subMateri) { const submateri = dunia.subMateri[submateriId]; const isCompleted = activeUser.progress[activeUser.jenjang]?.[duniaId]?.[submateriId]; const card = document.createElement('div'); card.className = `p-5 rounded-xl shadow-md cursor-pointer card-hover flex items-center justify-between border-2 ${colors.border}`; card.style.backgroundColor = isCompleted ? `var(--card-bg-color)`: 'var(--card-bg-color)'; card.innerHTML = `<span class="font-semibold ${colors.text}">${submateri.judul}</span> ${isCompleted ? `<span class="text-2xl text-yellow-500 star-animation">⭐</span>` : `<span class="w-6 h-6 rounded-full border-2 ${colors.border}"></span>`}`; card.addEventListener('click', () => { playSound('click'); currentSubmateriId = submateriId; renderMateri(duniaId, submateriId); switchScreen('materi-screen'); }); domElements.submateriContainer.appendChild(card); } }
        function renderMateri(duniaId, submateriId) { 
            const isHiddenWorld = duniaId === 'dunia_tersembunyi';
            const materi = isHiddenWorld ? { namaDunia: "Dunia Tersembunyi", warna: "slate", icon: "🗝️", judul: "Tantangan Campuran 1", konten: "<p>Uji pengetahuanmu dari berbagai bidang!</p>", funFact: "Otak manusia lebih aktif saat tidur daripada saat menonton TV.", kuis: [{ type: "pilihan-ganda", pertanyaan: "Ibukota dari negara Australia adalah...", pilihan: ["Sydney", "Melbourne", "Canberra"], jawaban: "Canberra", hint:"Bukan kota yang paling terkenal." }] } : edukasiData[activeUser.jenjang].dunia[duniaId].subMateri[submateriId];

            const colors = colorMapping[isHiddenWorld ? 'slate' : edukasiData[activeUser.jenjang].dunia[duniaId].warna]; 
            if(!materi || !materi.kuis || !materi.kuis[0]){ domElements.materiContent.innerHTML = `<h2 class="font-brand text-3xl ${colors.text} mb-4">Materi Belum Tersedia</h2><p>Konten untuk materi ini sedang dalam pengembangan. Silakan kembali lagi nanti!</p>`; return; } 
            
            const quiz = materi.kuis[0]; 
            let hintUsed = false;
            let optionsHTML = ''; if (quiz.type === 'pilihan-ganda') { const shuffled = [...quiz.pilihan].sort(() => .5 - Math.random()); shuffled.forEach(o => { optionsHTML += `<button class="quiz-option w-full text-left p-4 my-2 border-2 ${colors.border} rounded-lg hover:${colors.bg} font-semibold">${o}</button>`; }); } else if (quiz.type === 'benar-salah') { optionsHTML += `<button class="quiz-option w-full text-left p-4 my-2 border-2 ${colors.border} rounded-lg hover:${colors.bg} font-semibold">Benar</button><button class="quiz-option w-full text-left p-4 my-2 border-2 ${colors.border} rounded-lg hover:${colors.bg} font-semibold">Salah</button>`; } else if (quiz.type === 'isi-jawaban') { optionsHTML = `<div class="flex gap-2 items-center"><input type="text" id="quiz-input-text" placeholder="Ketik jawabanmu..." class="w-full p-3 border-2 ${colors.border} rounded-lg"><button id="quiz-submit-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-5 rounded-lg">Jawab</button></div>`; } 
            
            let hintButtonHTML = '';
            if(quiz.hint){
                hintButtonHTML = `<button class="hint-button rounded-full p-2" title="Gunakan 5 Poin untuk Petunjuk"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12.01" y2="17"></line></svg></button>`;
            }
            
            domElements.materiContent.innerHTML = `<h2 class="font-brand text-3xl md:text-4xl ${colors.text} mb-4 flex items-center justify-between">${materi.judul}<span class="tts-button rounded-full p-2" title="Dengarkan materi"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg></span></h2><div class="prose max-w-none text-lg leading-relaxed">${materi.konten}</div><hr class="my-6 border-t-2 ${colors.border}"><div class="flex items-center justify-between"><h3 class="font-bold text-xl mb-3">Tantangan Cepat!</h3>${hintButtonHTML}</div><p class="mb-4 text-lg">${quiz.pertanyaan}</p><div id="quiz-options">${optionsHTML}</div><div id="quiz-feedback" class="mt-4 text-lg font-bold"></div>`; 
            domElements.materiContent.querySelector('.tts-button').addEventListener('click', () => speak(`${materi.judul}. ${domElements.materiContent.querySelector('.prose').textContent}`)); 
            
            const hintBtn = domElements.materiContent.querySelector('.hint-button');
            if (hintBtn) {
                hintBtn.addEventListener('click', () => {
                    if (activeUser.points >= 5) {
                        addPoints(-5, null, false);
                        showMascotTip(`Ini petunjuknya: "${quiz.hint}"`);
                        hintUsed = true;
                        hintBtn.disabled = true;
                        hintBtn.classList.add('opacity-50');
                    } else {
                        playSound('wrong');
                        showMascotTip("Poinmu tidak cukup untuk menggunakan petunjuk!");
                    }
                });
            }

            if(quiz.type === 'isi-jawaban'){ document.getElementById('quiz-submit-btn').addEventListener('click', (e) => handleQuizAnswer(document.getElementById('quiz-input-text'), quiz.jawaban, duniaId, submateriId, quiz.type, hintUsed)); document.getElementById('quiz-input-text').addEventListener('keyup', e => { if (e.key === 'Enter') handleQuizAnswer(e.target, quiz.jawaban, duniaId, submateriId, quiz.type, hintUsed); }); } else { domElements.materiContent.querySelectorAll('.quiz-option').forEach(b => b.addEventListener('click', (e) => handleQuizAnswer(e.target, quiz.jawaban, duniaId, submateriId, quiz.type, hintUsed))); } }
        function checkAndAwardBadges() { const jenjang = activeUser.jenjang; const dataDunia = edukasiData[jenjang].dunia; if(!activeUser.badges[jenjang]) activeUser.badges[jenjang] = []; const userBadges = activeUser.badges[jenjang]; let newBadgeEarned = false; for (const duniaId in dataDunia) { if (userBadges.includes(duniaId)) continue; const progress = activeUser.progress[jenjang]?.[duniaId] || {}; const total = Object.keys(dataDunia[duniaId].subMateri).length; const completed = Object.values(progress).filter(Boolean).length; if (total > 0 && completed === total) { userBadges.push(duniaId); newBadgeEarned = true; showMascotTip(`Luar biasa! Kamu telah menguasai ${dataDunia[duniaId].namaDunia} dan mendapatkan lencana baru!`); } } const allWorldsDone = Object.keys(dataDunia).every(duniaId => userBadges.includes(duniaId)); if (allWorldsDone && !userBadges.includes('cendekia')) { userBadges.push('cendekia'); newBadgeEarned = true; setTimeout(() => { hideModals(); domElements.certificateName.textContent = activeUser.name; showModal('certificate-modal'); }, 1500); } if (newBadgeEarned) { playSound('badge'); saveData(); } }
        function renderAchievements() { const jenjang = activeUser.jenjang; if (!edukasiData[jenjang]) return; const badgesDef = edukasiData[jenjang].badges; const userBadges = activeUser.badges[jenjang] || []; domElements.achievementsList.innerHTML = ''; if (!badgesDef || Object.keys(badgesDef).length === 0) { domElements.achievementsList.innerHTML = '<p>Lencana untuk jenjang ini belum tersedia.</p>'; return; } Object.keys(badgesDef).forEach(badgeId => { const badge = badgesDef[badgeId]; const hasBadge = userBadges.includes(badge.id); const badgeEl = document.createElement('div'); badgeEl.className = `badge flex items-center p-3 rounded-lg border-2 ${hasBadge ? 'border-amber-400 bg-amber-50' : 'border-gray-300 opacity-60'}`; badgeEl.innerHTML = `<div class="text-4xl mr-4 ${hasBadge ? '' : 'filter grayscale'}">${badge.icon}</div><div><h4 class="font-bold text-lg ${hasBadge ? 'text-amber-700' : ''}">${badge.title}</h4><p class="text-sm ${hasBadge ? 'text-amber-600' : ''}">${badge.description}</p></div>`; domElements.achievementsList.appendChild(badgeEl); }); }
        function renderLeaderboard() { domElements.leaderboardList.innerHTML = ''; const sortedUsers = [...userProfiles].sort((a, b) => b.points - a.points); sortedUsers.forEach((user, index) => { const rank = index + 1; const medal = rank === 1 ? '🥇' : rank === 2 ? '🥈' : rank === 3 ? '🥉' : `#${rank}`; const isCurrentUser = user.id === activeUser.id; const row = document.createElement('div'); row.className = `flex items-center justify-between p-3 rounded-lg cursor-pointer hover:bg-gray-100 ${isCurrentUser ? 'bg-blue-100 border-2 border-blue-400' : 'bg-gray-50'}`; row.innerHTML = `<div class="flex items-center gap-3"><span class="font-bold text-lg w-8 text-center">${medal}</span><span class="font-semibold">${user.name}</span></div><span class="font-bold text-amber-600">${user.points} Poin</span>`; row.addEventListener('click', () => renderStatsPage(user)); domElements.leaderboardList.appendChild(row); }); }
        function checkDailyMission() { const today = new Date().toDateString(); if (!activeUser.dailyMission || activeUser.dailyMission.date !== today) { generateNewDailyMission(); } }
        function updateDailyMissionProgress(type, detail) { const mission = activeUser.dailyMission; if (mission.claimed || mission.current >= mission.target) return; if(mission.type === type || (mission.type === 'quiz_completed_any' && type === 'quiz_completed') || (mission.type === 'quiz_completed_subject' && type === 'quiz_completed' && edukasiData[activeUser.jenjang].dunia[detail]?.namaDunia.toLowerCase().includes(mission.detail.toLowerCase()) ) ) { mission.current++; } saveData(); }
        function renderDailyMission() { const mission = activeUser.dailyMission; domElements.dailyMissionText.textContent = mission.description; const progress = (mission.current / mission.target) * 100; domElements.missionProgressBar.style.width = `${progress}%`; domElements.missionProgressBar.textContent = `${Math.floor(progress)}%`; if (mission.current >= mission.target && !mission.claimed) { domElements.claimMissionRewardBtn.disabled = false; domElements.claimMissionRewardBtn.textContent = `Klaim Hadiah (${mission.reward} Poin)!`; } else if (mission.claimed) { domElements.claimMissionRewardBtn.disabled = true; domElements.claimMissionRewardBtn.textContent = 'Hadiah Sudah Diklaim'; } else { domElements.claimMissionRewardBtn.disabled = true; domElements.claimMissionRewardBtn.textContent = `Selesaikan ${mission.target - mission.current} lagi`; } }
        function setupNewUserScreen() { domElements.avatarSelectionContainer.innerHTML = ''; Object.keys(avatarData).filter(id => avatarData[id].isStarter).forEach(avatarId => { const avatarEl = document.createElement('div'); avatarEl.className = 'avatar-selection w-20 h-20 p-1'; avatarEl.dataset.avatarId = avatarId; avatarEl.innerHTML = avatarData[avatarId].svg; avatarEl.addEventListener('click', () => { document.querySelectorAll('.avatar-selection').forEach(el => el.classList.remove('selected')); avatarEl.classList.add('selected'); selectedAvatarId = avatarId; validateNewUserInput(); }); domElements.avatarSelectionContainer.appendChild(avatarEl); }); domElements.playerNameInput.value = ''; selectedAvatarId = null; validateNewUserInput(); switchScreen('name-entry-screen'); }
        function validateNewUserInput() { const name = domElements.playerNameInput.value.trim(); if (name && selectedAvatarId) { domElements.nextToLevelBtn.disabled = false; } else { domElements.nextToLevelBtn.disabled = true; } }
        function showMascotTip(message) { domElements.mascotTipContainer.innerHTML = ''; const tipEl = document.createElement('div'); tipEl.className = 'mascot-tip'; tipEl.innerHTML = `<div class="w-12 h-12 mr-3">${mascotSVG}</div><p class="text-sm">${message}</p>`; domElements.mascotTipContainer.appendChild(tipEl); setTimeout(() => { tipEl.remove(); }, 6000); }
        function toggleMusic(forceState) { let musicOn = forceState ?? !activeUser.settings.musicOn; if(musicOn){ domElements.backgroundMusic.play().catch(e=>console.log("Autoplay blocked")); domElements.musicToggleBtn.textContent = '🎵'; } else { domElements.backgroundMusic.pause(); domElements.musicToggleBtn.textContent = '🎶'; } activeUser.settings.musicOn = musicOn; saveData(); }
        function setWordOfTheDay() { const words = [ {kata: "Edukasi", arti: "Proses pembelajaran atau pemerolehan pengetahuan."}, {kata: "Inovasi", arti: "Penemuan baru atau pembaruan yang bermanfaat."}, {kata: "Kolaborasi", arti: "Kerja sama untuk mencapai tujuan bersama."}, {kata: "Literasi", arti: "Kemampuan membaca dan menulis."}, {kata: "Kompeten", arti: "Cakap atau memiliki kemampuan yang diperlukan."} ]; const dayIndex = new Date().getDate() % words.length; domElements.wordOfTheDay.innerHTML = `<strong>${words[dayIndex].kata}:</strong> ${words[dayIndex].arti}`; }
        function generateNewDailyMission() { const missions = [ { type: 'quiz_completed_any', description: (t) => `Selesaikan ${t} kuis hari ini.`, target: 3, reward: 25 }, { type: 'correct_answer', description: (t) => `Jawab ${t} pertanyaan dengan benar.`, target: 5, reward: 30 }, { type: 'quiz_completed_subject', description: (t, d) => `Selesaikan ${t} kuis di dunia ${d}.`, target: 2, reward: 40, detail: "Angka" }, { type: 'quiz_completed_subject', description: (t, d) => `Selesaikan ${t} kuis di dunia ${d}.`, target: 1, reward: 20, detail: "Sains" } ]; const mission = missions[Math.floor(Math.random() * missions.length)]; activeUser.dailyMission = { date: new Date().toDateString(), type: mission.type, description: mission.description(mission.target, mission.detail), target: mission.target, current: 0, reward: mission.reward, detail: mission.detail, claimed: false }; saveData(); }
        function startTimedChallenge() { playSound('open'); showModal('timed-challenge-modal'); let timeLeft = 60; let score = 0; let questions = []; let currentQuestionIndex = 0;
            const allQuizzes = Object.values(edukasiData[activeUser.jenjang].dunia).flatMap(dunia => Object.values(dunia.subMateri).map(sm => sm.kuis[0])).filter(q => q);
            questions = [...allQuizzes].sort(() => 0.5 - Math.random()).slice(0, 10);
            
            function renderChallengeQuestion() {
                if (currentQuestionIndex >= questions.length) { endChallenge(); return; }
                const quiz = questions[currentQuestionIndex];
                let optionsHTML = '';
                quiz.pilihan.forEach(o => { optionsHTML += `<button class="challenge-option w-full text-left p-3 my-2 border-2 border-gray-300 rounded-lg hover:bg-gray-100">${o}</button>`; });
                domElements.challengeQuestionArea.innerHTML = `<p class="font-bold text-lg mb-3">${quiz.pertanyaan}</p>${optionsHTML}`;
                domElements.challengeQuestionArea.querySelectorAll('.challenge-option').forEach(btn => {
                    btn.addEventListener('click', e => {
                        if (e.target.textContent === quiz.jawaban) {
                            score++;
                            domElements.challengeFeedback.textContent = "Benar!";
                            domElements.challengeFeedback.className = 'mt-4 font-bold text-green-600';
                        } else {
                            domElements.challengeFeedback.textContent = "Salah!";
                             domElements.challengeFeedback.className = 'mt-4 font-bold text-red-600';
                        }
                        currentQuestionIndex++;
                        setTimeout(() => { domElements.challengeFeedback.textContent = ''; renderChallengeQuestion(); }, 500);
                    });
                });
            }

            function endChallenge() { clearInterval(timedChallengeInterval); domElements.challengeQuestionArea.innerHTML = `<h4 class="font-bold text-2xl">Waktu Habis!</h4><p class="text-lg mt-2">Skor Anda: ${score} / ${currentQuestionIndex}</p><p class="text-lg mt-1">Anda mendapatkan ${score * 5} Poin Bonus!</p>`; addPoints(score * 5); domElements.closeTimedChallengeBtn.classList.remove('hidden'); }
            
            timedChallengeInterval = setInterval(() => {
                timeLeft--;
                domElements.challengeTimer.textContent = `Sisa Waktu: ${timeLeft} detik`;
                if (timeLeft <= 0) endChallenge();
            }, 1000);

            domElements.challengeQuestionArea.innerHTML = '';
            domElements.challengeFeedback.textContent = '';
            domElements.closeTimedChallengeBtn.classList.add('hidden');
            renderChallengeQuestion();
        }
        function renderStatsPage(user) { hideModals(); domElements.statsUsername.textContent = `Statistik ${user.name}`; 
            const jenjang = user.jenjang; const badges = jenjang ? edukasiData[jenjang].badges : {}; const userBadges = user.badges[jenjang] || [];
            domElements.statsContent.innerHTML = `
                <div class="p-3 bg-amber-50 rounded-lg flex justify-between items-center"><strong>Poin:</strong> <span class="font-bold text-amber-700">${user.points}</span></div>
                <div class="p-3 bg-green-50 rounded-lg flex justify-between items-center"><strong>Kuis Selesai:</strong> <span class="font-bold text-green-700">${user.stats.quizzesCompleted || 0}</span></div>
                <div class="p-3 bg-sky-50 rounded-lg flex justify-between items-center"><strong>Lencana Didapat:</strong> <span class="font-bold text-sky-700">${userBadges.length} / ${Object.keys(badges).length}</span></div>
                <div class="p-3 bg-red-50 rounded-lg flex justify-between items-center"><strong>Login Beruntun:</strong> <span class="font-bold text-red-700">${user.loginStreak || 0} Hari</span></div>
            `;
            showModal('stats-modal'); 
        }

        function setDailyBonusWorld() {
            const jenjang = activeUser.jenjang;
            const allDuniaIds = Object.keys(edukasiData[jenjang].dunia);
            const dayIndex = new Date().getDate() % allDuniaIds.length;
            dailyBonusWorldId = allDuniaIds[dayIndex];
        }
        
        function openGenericShop(shopId) {
            hideModals();
            const shop = shopData[shopId];
            if (!shop) return;
            domElements.genericShopTitle.textContent = shop.title;
            domElements.genericShopPoints.textContent = `💰 Poin: ${activeUser.points}`;
            const container = domElements.genericShopContainer;
            container.innerHTML = '';

            for (const itemId in shop.items) {
                const item = shop.items[itemId];
                const itemEl = document.createElement('div');
                itemEl.className = 'p-4 border rounded-lg flex flex-col items-center text-center';
                itemEl.innerHTML = `
                    <div class="text-4xl mb-2">${item.icon}</div>
                    <div class="font-bold">${item.name}</div>
                    <div class="text-sm text-amber-700 font-semibold my-1">${item.price} Poin</div>
                    <button class="buy-item-btn mt-2 bg-green-500 hover:bg-green-600 text-white px-4 py-1 rounded-full text-sm font-bold" data-shop-id="${shopId}" data-item-id="${itemId}">Beli</button>
                `;
                container.appendChild(itemEl);
            }
            showModal('generic-shop-modal');
        }

        // --- Event Listeners ---
        domElements.addNewUserBtn.addEventListener('click', () => { playSound('click'); setupNewUserScreen(); });
        domElements.cancelNewUserBtn.addEventListener('click', () => { playSound('click'); if (userProfiles.length > 0) renderUserSelectionScreen(); else switchScreen('loading-screen'); });
        domElements.playerNameInput.addEventListener('input', validateNewUserInput);
        domElements.nextToLevelBtn.addEventListener('click', () => { const name = domElements.playerNameInput.value.trim(); if (name && selectedAvatarId) { playSound('click'); createNewUser(name, selectedAvatarId); } });
        document.querySelectorAll('.jenjang-btn').forEach(b => { b.addEventListener('click', (e) => { playSound('click'); activeUser.jenjang = e.currentTarget.dataset.jenjang; initializeProgressForJenjang(activeUser.jenjang); startSession(); }); });
        domElements.settingsBtn.addEventListener('click', () => { playSound('click'); domElements.editNameInput.value = activeUser.name; domElements.changeJenjangSelect.value = activeUser.jenjang; domElements.soundToggleBtn.textContent = activeUser.settings.soundOn ? '🔊' : '🔇'; domElements.musicToggleBtn.textContent = activeUser.settings.musicOn ? '🎵' : '🎶'; applyTheme(activeUser.settings.theme); showModal('settings-modal'); });
        document.querySelectorAll('.settings-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.settings-tab').forEach(t => t.classList.remove('border-sky-500', 'text-sky-600'));
                tab.classList.add('border-sky-500', 'text-sky-600');
                document.querySelectorAll('.settings-tab-pane').forEach(pane => pane.style.display = 'none');
                document.getElementById('tab-' + tab.dataset.tab).style.display = 'block';
            });
        });
        domElements.closeSettingsBtn.addEventListener('click', () => { playSound('click'); hideModals(); });
        domElements.saveNameBtn.addEventListener('click', () => { const newName = domElements.editNameInput.value.trim(); if (newName && newName !== activeUser.name) { playSound('correct'); activeUser.name = newName; saveData(); updateUI(); domElements.saveNameBtn.textContent = 'OK!'; setTimeout(() => { domElements.saveNameBtn.textContent = 'Simpan'; }, 1500); } });
        domElements.changeJenjangSelect.addEventListener('change', () => { const newJenjang = domElements.changeJenjangSelect.value; if (newJenjang !== activeUser.jenjang) { playSound('click'); activeUser.jenjang = newJenjang; initializeProgressForJenjang(newJenjang); saveData(); updateUI(); renderDuniaMap(); hideModals(); } });
        domElements.userAvatarHeader.addEventListener('click', () => { playSound('click'); hideModals(); renderUserSelectionScreen(); });
        domElements.resetProgressBtn.addEventListener('click', () => { playSound('click'); domElements.resetUsernameConfirm.textContent = activeUser.name; hideModals(); showModal('confirm-reset-modal'); });
        domElements.cancelResetBtn.addEventListener('click', () => { playSound('click'); hideModals(); showModal('settings-modal'); });
        domElements.confirmResetBtn.addEventListener('click', () => { playSound('wrong'); activeUser.points = 0; activeUser.progress = {}; activeUser.badges = {}; initializeProgressForJenjang(activeUser.jenjang); saveData(); hideModals(); startSession(); });
        domElements.backToWorldsBtn.addEventListener('click', () => { playSound('click'); renderDuniaMap(); switchScreen('map-screen'); });
        domElements.backToSubmateriBtn.addEventListener('click', () => { playSound('click'); renderSubMateri(currentDuniaId); switchScreen('submateri-screen'); });
        domElements.achievementsBtn.addEventListener('click', () => { playSound('click'); renderAchievements(); showModal('achievements-modal'); });
        domElements.closeAchievementsBtn.addEventListener('click', () => { playSound('click'); hideModals(); });
        domElements.closeFunFactBtn.addEventListener('click', () => { playSound('click'); hideModals(); renderSubMateri(currentDuniaId); switchScreen('submateri-screen'); });
        domElements.closeCertificateBtn.addEventListener('click', () => { playSound('badge'); hideModals(); });
        domElements.leaderboardBtn.addEventListener('click', () => { playSound('click'); renderLeaderboard(); showModal('leaderboard-modal'); });
        domElements.closeLeaderboardBtn.addEventListener('click', () => { playSound('click'); hideModals(); });
        domElements.dailyMissionBtn.addEventListener('click', () => { playSound('click'); renderDailyMission(); showModal('daily-mission-modal'); });
        domElements.closeDailyMissionBtn.addEventListener('click', () => { playSound('click'); hideModals(); });
        domElements.claimMissionRewardBtn.addEventListener('click', () => { if (!activeUser.dailyMission.claimed && activeUser.dailyMission.current >= activeUser.dailyMission.target) { playSound('badge'); addPoints(activeUser.dailyMission.reward); activeUser.dailyMission.claimed = true; saveData(); updateUI(); renderDailyMission(); } });
        domElements.closeDailyBonusBtn.addEventListener('click', () => { playSound('click'); hideModals(); });
        domElements.soundToggleBtn.addEventListener('click', () => { activeUser.settings.soundOn = !activeUser.settings.soundOn; domElements.soundToggleBtn.textContent = activeUser.settings.soundOn ? '🔊' : '🔇'; saveData(); if(activeUser.settings.soundOn) playSound('click'); });
        domElements.themeSelector.addEventListener('click', e => { if(e.target.tagName === 'BUTTON') { playSound('click'); applyTheme(e.target.dataset.theme); }});
        domElements.closeAvatarShopBtn.addEventListener('click', () => { playSound('click'); hideModals(); });
        domElements.shareProgressBtn.addEventListener('click', () => { const jenjang = {sd: "SD", smp: "SMP", sma: "SMA", kuliah: "Kuliah"}[activeUser.jenjang]; const badgeCount = activeUser.badges[activeUser.jenjang]?.length || 0; const text = `Saya telah mencapai ${activeUser.points} poin dan mendapatkan ${badgeCount} lencana di jenjang ${jenjang} dalam Petualangan Pengetahuan! 🚀 #BelajarSeru`; navigator.clipboard.writeText(text).then(() => showMascotTip("Prestasi disalin! Bagikan ke teman-temanmu!")); });
        domElements.musicToggleBtn.addEventListener('click', () => toggleMusic());
        domElements.searchBar.addEventListener('input', (e) => renderDuniaMap(e.target.value));
        domElements.timedChallengeBtn.addEventListener('click', startTimedChallenge);
        domElements.closeTimedChallengeBtn.addEventListener('click', () => hideModals());
        domElements.closeStatsBtn.addEventListener('click', () => { hideModals(); showModal('leaderboard-modal'); });
        
        // Shop Hub Listeners
        document.getElementById('shop-hub-btn').addEventListener('click', () => { playSound('open'); showModal('shop-hub-modal'); });
        document.getElementById('close-shop-hub-btn').addEventListener('click', () => { playSound('click'); hideModals(); });
        document.getElementById('open-avatar-shop').addEventListener('click', () => { playSound('click'); hideModals(); renderAvatarShop(); showModal('avatar-shop-modal'); });
        document.getElementById('open-customization-shop').addEventListener('click', () => { playSound('click'); openGenericShop('customization'); });
        document.getElementById('open-powerup-shop').addEventListener('click', () => { playSound('click'); openGenericShop('powerup'); });
        document.getElementById('open-mascot-shop').addEventListener('click', () => { playSound('click'); openGenericShop('mascot'); });
        document.querySelectorAll('.generic-shop-close-btn').forEach(btn => btn.addEventListener('click', () => { playSound('click'); hideModals(); }));

        initializeApp();
    </script>
</body>
</html>